-- migExtLoggingGroup.sql : Migrate from E-Maj 1.3. to next_version while groups are in logging state.
--
-----------------------------
-- emaj update to next_version
-----------------------------
--\! cp /usr/local/pg912/share/postgresql/extension/emaj.control.0.12.0 /usr/local/pg912/share/postgresql/extension/emaj.control
-- check the extension is available
select * from pg_available_extension_versions where name = 'emaj';
 name |   version    | installed | superuser | relocatable | schema | requires |                                            comment                                             
------+--------------+-----------+-----------+-------------+--------+----------+------------------------------------------------------------------------------------------------
 emaj | next_version | f         | t         | f           | emaj   | {dblink} | E-Maj extension enables fine-grained write logging and time travel on subsets of the database.
(1 row)

--TODO debug
--select * from emaj.emaj_seq_hole order by sqhl_schema, sqhl_table;
--select mark_group, mark_name, mark_id, mark_datetime, mark_global_seq, mark_last_seq_hole_id from emaj.emaj_mark order by mark_id;
--select * from emaj.emaj_rlbk order by rlbk_id;
-- process the extension migration
ALTER EXTENSION emaj UPDATE TO 'next_version';
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to constraint emaj_relation_rel_group_fkey on table emaj_relation
drop cascades to constraint emaj_mark_mark_group_fkey on table emaj_mark
NOTICE:  E-Maj upgrade: internal error, the number of rows in the original emaj_seq_hole (4) doesn't math the number of rows in the new emaj_seq_hole table (0)
NOTICE:  event trigger "emaj_protection_trg" does not exist, skipping
CONTEXT:  SQL statement "
DROP EVENT TRIGGER IF EXISTS emaj_protection_trg;
CREATE EVENT TRIGGER emaj_protection_trg
  ON sql_drop
  WHEN TAG IN ('DROP EXTENSION','DROP SCHEMA')
  EXECUTE PROCEDURE public._emaj_protection_event_trigger_fnct();
"
PL/pgSQL function inline_code_block line 39 at EXECUTE statement
NOTICE:  event trigger "emaj_sql_drop_trg" does not exist, skipping
CONTEXT:  SQL statement "
DROP EVENT TRIGGER IF EXISTS emaj_sql_drop_trg;
CREATE EVENT TRIGGER emaj_sql_drop_trg
  ON sql_drop
  WHEN TAG IN ('DROP FUNCTION','DROP SCHEMA','DROP SEQUENCE','DROP TABLE','DROP TRIGGER')
  EXECUTE PROCEDURE emaj._event_trigger_sql_drop_fnct();
"
PL/pgSQL function inline_code_block line 152 at EXECUTE statement
--TODO debug
--select * from emaj.emaj_seq_hole order by sqhl_schema, sqhl_table;
--select mark_group, mark_name, mark_id, mark_datetime, mark_global_seq from emaj.emaj_mark order by mark_id;
-----------------------------
-- check installation
-----------------------------
-- check impact in catalog
select extname, extversion from pg_extension where extname = 'emaj';
 extname |  extversion  
---------+--------------
 emaj    | next_version
(1 row)

-- check the emaj_param content
SELECT param_value_text FROM emaj.emaj_param WHERE param_key = 'emaj_version';
 param_value_text 
------------------
 2.0.0
(1 row)

