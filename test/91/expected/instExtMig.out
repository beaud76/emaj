-- instExtMig.sql : Upgrade from E-Maj 1.3.0 to next_version while groups are not yet created.
-- install E-Maj as an extension 
--
------------------------------------------------------------
-- install dblink
------------------------------------------------------------
CREATE EXTENSION IF NOT EXISTS dblink;
-----------------------------
-- for postgres cluster 9.1 and 9.4, temporarily rename tspemaj tablespace to test both cases
-----------------------------
DO LANGUAGE plpgsql 
$$
  DECLARE
  BEGIN
    IF substring (version() from E'PostgreSQL\\s(\\d+\\.\\d+)') IN ('9.1', '9.4') THEN
      ALTER TABLESPACE tspemaj RENAME TO tspemaj_renamed;
    END IF;
  END;
$$;
-----------------------------
-- check the extension's availability
-----------------------------
-- check the extension is available in the right version 
select * from pg_available_extension_versions where name = 'emaj';
 name |   version    | installed | superuser | relocatable | schema | requires |                                            comment                                             
------+--------------+-----------+-----------+-------------+--------+----------+------------------------------------------------------------------------------------------------
 emaj | next_version | f         | t         | f           | emaj   | {dblink} | E-Maj extension enables fine-grained write logging and time travel on subsets of the database.
(1 row)

-- look at all available update paths
select * from pg_extension_update_paths('emaj') order by 1,2;;
    source    |    target    |              path               
--------------+--------------+---------------------------------
 1.3.1        | next_version | 1.3.1--next_version
 1.3.1        | unpackaged   | 
 next_version | 1.3.1        | 
 next_version | unpackaged   | 
 unpackaged   | 1.3.1        | unpackaged--1.3.1
 unpackaged   | next_version | unpackaged--1.3.1--next_version
(6 rows)

-----------------------------------------------------------
-- test that a 1.3.1 version moved as an extension can be dropped
-----------------------------------------------------------
-- emaj 1.3.1 installation using the psql script
\unset ECHO
E-Maj objects creation...
 emaj_tmp_pre_install 
----------------------
 
(1 row)

 _tmp_create_some_components 
-----------------------------
 
(1 row)

psql:../../../emaj-1.3.1/sql/emaj.sql:6639: WARNING:  E-Maj installation: the dblink functions exist in schema(s): public. Be sure these functions will be accessible by emaj_adm roles through their schemas search_path.
 _tmp_post_install 
-------------------
 
(1 row)

>>> E-Maj objects successfully created
-- transform emaj object as extension
CREATE EXTENSION emaj VERSION '1.3.1' FROM unpackaged;
-- check impact in catalog
select extname, extversion from pg_extension;
 extname | extversion 
---------+------------
 plpgsql | 1.0
 dblink  | 1.0
 emaj    | 1.3.1
(3 rows)

-- drop the extension
DROP EXTENSION emaj;
-- verify that all emaj tables, views, types and functions have been included in the extension and then deleted 
-- both tables and functions list should be empty 
select relname from pg_class,pg_namespace where relnamespace = pg_namespace.oid and nspname = 'emaj';
 relname 
---------
(0 rows)

select proname from pg_proc,pg_namespace where pronamespace = pg_namespace.oid and nspname = 'emaj';
 proname 
---------
(0 rows)

-----------------------------------------------------------
-- emaj update to next_version
-----------------------------------------------------------
-- emaj 1.3.1 installation using the psql script
\unset ECHO
E-Maj objects creation...
 emaj_tmp_pre_install 
----------------------
 
(1 row)

 _tmp_create_some_components 
-----------------------------
 
(1 row)

psql:../../../emaj-1.3.1/sql/emaj.sql:6639: WARNING:  E-Maj installation: the dblink functions exist in schema(s): public. Be sure these functions will be accessible by emaj_adm roles through their schemas search_path.
 _tmp_post_install 
-------------------
 
(1 row)

>>> E-Maj objects successfully created
-- transform emaj object as extension
CREATE EXTENSION emaj VERSION '1.3.1' FROM unpackaged;
-- check impact in catalog
select extname, extversion from pg_extension where extname = 'emaj';
 extname | extversion 
---------+------------
 emaj    | 1.3.1
(1 row)

-- process the extension upgrade
ALTER EXTENSION emaj UPDATE TO 'next_version';
NOTICE:  CREATE TABLE will create implicit sequence "emaj_time_stamp_time_id_seq" for serial column "emaj_time_stamp.time_id"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_time_stamp_pkey" for table "emaj_time_stamp"
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to constraint emaj_relation_rel_group_fkey on table emaj_relation
drop cascades to constraint emaj_mark_mark_group_fkey on table emaj_mark
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_group_pkey" for table "emaj_group"
NOTICE:  CREATE TABLE will create implicit sequence "emaj_mark_mark_id_seq" for serial column "emaj_mark.mark_id"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_mark_pkey" for table "emaj_mark"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_sequence_pkey" for table "emaj_sequence"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_seq_hole_pkey" for table "emaj_seq_hole"
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to constraint emaj_rlbk_session_rlbs_rlbk_id_fkey on table emaj_rlbk_session
drop cascades to constraint emaj_rlbk_plan_rlbp_rlbk_id_fkey on table emaj_rlbk_plan
NOTICE:  CREATE TABLE will create implicit sequence "emaj_rlbk_rlbk_id_seq" for serial column "emaj_rlbk.rlbk_id"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_rlbk_pkey" for table "emaj_rlbk"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "emaj_rlbk_stat_pkey" for table "emaj_rlbk_stat"
-----------------------------------------------------------
-- check installation
-----------------------------------------------------------
-- check impact in catalog
select extname, extversion from pg_extension where extname = 'emaj';
 extname |  extversion  
---------+--------------
 emaj    | next_version
(1 row)

-- check the emaj_param content
SELECT param_value_text FROM emaj.emaj_param WHERE param_key = 'emaj_version';
 param_value_text 
------------------
 <NEXT_VERSION>
(1 row)

-- check history
select hist_id, hist_function, hist_event, hist_object, regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'), hist_user from 
  (select * from emaj.emaj_hist order by hist_id) as t;
 hist_id | hist_function | hist_event |     hist_object      |           regexp_replace            | hist_user 
---------+---------------+------------+----------------------+-------------------------------------+-----------
       1 | EMAJ_INSTALL  |            | E-Maj 1.3.1          | Initialisation completed            | postgres
       2 | EMAJ_INSTALL  |            | E-Maj 1.3.0          | E-Maj transformed into an EXTENSION | postgres
       3 | EMAJ_INSTALL  |            | E-Maj <NEXT_VERSION> | Upgrade from 1.3.1 completed        | postgres
(3 rows)

