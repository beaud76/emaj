-- instExtMig.sql : install E-Maj as an extension (for postgres version 9.1+)
--               The extension is already installed. This script only performs the update
--
-----------------------------
-- emaj update to 0.12.0
-----------------------------
\! cp /usr/local/pg912/share/postgresql/extension/emaj.control.0.12.0 /usr/local/pg912/share/postgresql/extension/emaj.control
-- check the extension is available
select * from pg_available_extension_versions where name = 'emaj';
 name | version | installed | superuser | relocatable | schema | requires |                              comment                              
------+---------+-----------+-----------+-------------+--------+----------+-------------------------------------------------------------------
 emaj | 0.12.0  | f         | t         | f           | emaj   |          | E-Maj extension helps log and rollback updates on sets of tables.
 emaj | 0.10.1  | t         | t         | f           | emaj   |          | E-Maj extension helps log and rollback updates on sets of tables.
(2 rows)

-- process the extension migration
ALTER EXTENSION emaj UPDATE TO '0.12.0';
ERROR:  cannot drop table pg_temp_643649 because extension emaj requires it
HINT:  You can drop extension emaj instead.
CONTEXT:  SQL statement "ALTER TABLE emaj."myschema1_myTbl3_log" ADD COLUMN emaj_verb    VARCHAR(3), ADD COLUMN emaj_tuple   VARCHAR(3), ADD COLUMN emaj_gid     BIGINT      NOT NULL   DEFAULT nextval('emaj.emaj_global_seq'), ADD COLUMN emaj_changed TIMESTAMPTZ DEFAULT clock_timestamp(), ADD COLUMN emaj_txid    BIGINT      DEFAULT emaj._txid_current(), ADD COLUMN emaj_user    VARCHAR(32) DEFAULT session_user, ADD COLUMN emaj_user_ip INET        DEFAULT inet_client_addr()"
PL/pgSQL function "_create_tbl" line 76 at EXECUTE statement
SQL statement "SELECT emaj._create_tbl(r_table.rel_schema, r_table.rel_tblseq, r_table.group_is_rollbackable)"
PL/pgSQL function "inline_code_block" line 60 at PERFORM
-- drop the extension after having detached all emaj objects from it
--\i ../../sql/emaj--0.10.1--unpackaged.sql
--DROP EXTENSION emaj;
-- process the common emaj migration 
--\i ../../sql/emaj-0.10.1-to-0.12.0.sql
-- transform emaj objects as extension 
--CREATE EXTENSION emaj FROM unpackaged;
-----------------------------
-- check installation
-----------------------------
-- check impact in catalog
select extname, extversion from pg_extension where extname = 'emaj';
 extname | extversion 
---------+------------
 emaj    | 0.10.1
(1 row)

-- check the emaj_param content
SELECT param_value_text FROM emaj.emaj_param WHERE param_key = 'emaj_version';
 param_value_text 
------------------
 0.10.1
(1 row)

