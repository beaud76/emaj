-- instPsqlMig.sql: Migrate from previous to next E-Maj vesrion while groups are not yet created. 
-- Install E-Maj as simple psql script
--
-----------------------------
-- migrate to the target version
-----------------------------
\i ../../sql/emaj-1.2.0-to-1.3.0.sql
--
-- E-Maj: migration from 1.2.0 to 1.3.0
--
-- This software is distributed under the GNU General Public License.
--
-- This script migrates an existing installation of E-Maj extension.
-- If E-Maj is not yet installed, use the emaj.sql script. 
--
\set ON_ERROR_STOP ON
\set QUIET ON
SET client_min_messages TO WARNING;
--SET client_min_messages TO NOTICE;
\echo 'E-maj upgrade from version 1.2.0 to version 1.3.0'
E-maj upgrade from version 1.2.0 to version 1.3.0
\echo 'Checking...'
Checking...
------------------------------------
--                                --
-- checks                         --
--                                --
------------------------------------
-- Creation of a specific function to check the migration conditions are met.
-- The function generates an exception if at least one condition is not met.
DROP FUNCTION IF EXISTS emaj.tmp();
CREATE FUNCTION emaj.tmp() 
RETURNS VOID LANGUAGE plpgsql AS
$tmp$
  DECLARE
    v_emajVersion            TEXT;
    v_pgVersion              INTEGER = emaj._pg_version_num();
  BEGIN
-- check the current role is a superuser
    PERFORM 0 FROM pg_roles WHERE rolname = current_user AND rolsuper;
    IF NOT FOUND THEN
      RAISE EXCEPTION 'E-Maj installation: the current user (%) is not a superuser.', current_user;
    END IF;
-- the emaj version registered in emaj_param must be '1.2.0'
    SELECT param_value_text INTO v_emajVersion FROM emaj.emaj_param WHERE param_key = 'emaj_version';
    IF v_emajVersion <> '1.2.0' THEN
      RAISE EXCEPTION 'The current E-Maj version (%) is not 1.2.0',v_emajVersion;
    END IF;
-- the installed postgres version must be at least 8.3
    IF v_pgVersion < 803 THEN
      RAISE EXCEPTION 'The current PostgreSQL version (%) is not compatible with E-Maj 1.3.0 (8.3 minimum)',v_pgVersion;
    END IF;
    RETURN;
  END;
$tmp$;
SELECT emaj.tmp();
psql:../../sql/emaj-1.2.0-to-1.3.0.sql:48: ERROR:  The current E-Maj version (1.3.0) is not 1.2.0
-----------------------------
-- check installation
-----------------------------
-- check the emaj_param content
SELECT param_value_text FROM emaj.emaj_param WHERE param_key = 'emaj_version';
 param_value_text 
------------------
 1.3.0
(1 row)

