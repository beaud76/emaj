-- after_restore.sql: test the emaj environment restored from a dump taken at the end of schedule reg tests
-- All operations are executed by a super-user
--
-----------------------------
-- Checking restore
-----------------------------
DO LANGUAGE plpgsql $$
DECLARE
  r             RECORD;
  keepTable     BOOLEAN = false;
  delta         SMALLINT;
  expected_val  BIGINT;
  returned_val  BIGINT;
BEGIN
-- Comparing the number of rows in each table
  FOR r IN
    SELECT nspname, relname
      FROM pg_catalog.pg_class, pg_catalog.pg_namespace
     WHERE relnamespace = pg_namespace.oid
       AND relkind = 'r' AND nspname ~ '^emaj' AND relname !~ '^emaj_regtest'
     ORDER BY 1,2
  LOOP
    SELECT tbl_tuple INTO expected_val FROM emaj.emaj_regtest_dump_tbl WHERE tbl_schema = r.nspname AND tbl_name = r.relname;
    EXECUTE 'SELECT count(*) FROM '||quote_ident(r.nspname)||'.'||quote_ident(r.relname) INTO returned_val;
    IF NOT (expected_val = returned_val OR (r.nspname || '.' || r.relname = 'emaj.emaj_hist' AND expected_val = returned_val - 1)) THEN
-- the emaj_hist table may contain 1 more row created at extension creation
      RAISE WARNING 'Error, the table %.% contains % rows instead of %', quote_ident(r.nspname), quote_ident(r.relname), returned_val, expected_val;
      keepTable = true;
    END IF;
  END LOOP;
-- Comparing the properties of each sequence
  FOR r IN
    SELECT nspname, relname
      FROM pg_catalog.pg_class, pg_catalog.pg_namespace
     WHERE relnamespace = pg_namespace.oid
       AND relkind = 'S' AND nspname ~ '^emaj' AND relname !~ '^emaj_regtest' AND relname ~ '_seq$'
     ORDER BY 1,2
  LOOP
    EXECUTE 'SELECT * FROM emaj.emaj_regtest_dump_seq WHERE sequ_schema = ' || quote_literal(r.nspname) || ' AND sequ_name = ' || quote_literal(r.relname)
         || ' EXCEPT SELECT * FROM emaj._get_current_sequence_state(' || quote_literal(r.nspname) || ',' || quote_literal(r.relname) || ',0)';
    GET DIAGNOSTICS delta = ROW_COUNT;
    IF delta > 0 THEN
      SELECT sequ_last_val INTO expected_val FROM emaj.emaj_regtest_dump_seq WHERE sequ_schema = r.nspname AND sequ_name = r.relname;
      EXECUTE 'SELECT sequ_last_val FROM emaj._get_current_sequence_state(' || quote_literal(r.nspname) || ',' || quote_literal(r.relname) || ',0)'
        INTO returned_val;
      IF expected_val <> returned_val THEN
        RAISE WARNING 'Error, the sequence %.% has last_val equal to % instead of %', quote_ident(r.nspname), quote_ident(r.relname), returned_val, expected_val;
      ELSE
        RAISE WARNING 'Error, the properties of the sequence %.% are not the expected ones', quote_ident(r.nspname), quote_ident(r.relname);
      END IF;
      keepTable = true;
    END IF;
  END LOOP;
-- if everything is OK, drop both control tables created just before the database dump
  IF NOT keepTable THEN
    DROP TABLE emaj.emaj_regtest_dump_tbl, emaj.emaj_regtest_dump_seq;
  END IF;
END $$;
WARNING:  Error, the properties of the sequence emaj.emaj_rlbk_rlbk_id_seq are not the expected ones
DO
-----------------------------
-- Let's use the E-Maj environment
-----------------------------
-----------------------------
-- Step 1 : for myGroup2, update tables and set a mark 
-----------------------------
set search_path=myschema2;
SET
insert into myTbl1 select 100+i, 'KLM', E'\\000\\014'::bytea from generate_series (1,11) as i;
INSERT 0 11
update myTbl1 set col13=E'\\000\\034'::bytea where col11 >105;
UPDATE 6
insert into myTbl2 values (100,'KLM','2012-12-31');
INSERT 0 1
delete from myTbl1 where col11 > 110;
DELETE 1
select nextval('myschema2.myseq1');
 nextval 
---------
    1004
(1 row)

--
select emaj.emaj_set_mark_group('myGroup2','After restore mark');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

--
-----------------------------
-- Checking step 1
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |     mark_comment     | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+-----------------+------------------------+----------------------+---------------------------+------------------------------
 myGroup2   | M3                           |        10012 | t               | f                      | This mark is deleted |                         0 | 
 myGroup1   | M4                           |        10018 | t               | f                      |                      |                        10 | 
 myGroup1   | M5                           |        10019 | t               | f                      |                      |                         3 | 
 myGroup1   | Before logged rollback to M4 |        10025 | t               | f                      |                      |                        28 | 
 myGroup1   | STOP_%                       |        10027 | t               | f                      |                      |                         0 | 
 myGroup2   | STOP_%                       |        10027 | t               | f                      |                      |                         0 | 
 myGroup1   | Stop after rollback          |        10034 | t               | f                      |                      |                         0 | 
 myGroup2   | Stop after rollback          |        10034 | t               | f                      |                      |                         0 | 
 myGroup1   | Multi-1                      |        10035 | f               | f                      |                      |                         0 | 
 myGroup2   | Multi-1                      |        10035 | f               | f                      |                      |                        92 | 
 myGroup2   | RLBK_Multi-1_%_START         |        20001 | f               | f                      |                      |                        32 | 
 myGroup2   | RLBK_Multi-1_%_DONE          |        20002 | f               | f                      |                      |                        30 | Multi-1
 myGroup2   | RLBK_Multi-1_%_START         |        20201 | f               | f                      |                      |                        32 | 
 myGroup2   | RLBK_Multi-1_%_DONE          |        20202 | f               | f                      |                      |                         0 | Multi-1
 myGroup2   | RLBK_Multi-1_%_START         |        20203 | f               | f                      |                      |                        62 | 
 myGroup2   | RLBK_Multi-1_%_DONE          |        20204 | f               | f                      |                      |                        19 | Multi-1
 myGroup2   | After restore mark           |        20206 | f               | f                      |                      |                           | 
(17 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+-------------------+--------------+---------------+----------------
 emaj_myschema2 | mytbl1_log_seq    |        10012 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10012 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10012 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10012 |             4 | t
 emaj_myschema2 | mytbl5_log_seq    |        10012 |             4 | t
 emaj_myschema2 | mytbl6_log_seq    |        10012 |            14 | t
 myschema2      | myseq1            |        10012 |          1003 | t
 myschema2      | myTbl3_col31_seq  |        10012 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10018 |            30 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10018 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10018 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10018 |            10 | t
 emaj_myschema1 | mytbl4_log_seq    |        10018 |             8 | t
 myschema1      | mytbl2b_col20_seq |        10018 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10018 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10019 |            30 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10019 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10019 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10019 |            20 | t
 emaj_myschema1 | mytbl4_log_seq    |        10019 |             8 | t
 myschema1      | mytbl2b_col20_seq |        10019 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10019 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10025 |            32 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10025 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10025 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10025 |            20 | t
 emaj_myschema1 | mytbl4_log_seq    |        10025 |            12 | t
 myschema1      | mytbl2b_col20_seq |        10025 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10025 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10027 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10027 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10027 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10027 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10027 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10027 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10027 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10027 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10027 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10027 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10027 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10027 |            20 | t
 myschema2      | myseq1            |        10027 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10027 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10034 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10034 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10034 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10034 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10034 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10034 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10034 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10034 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10034 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10034 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10034 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10034 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10034 |            20 | t
 myschema2      | myseq1            |        10034 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10034 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10035 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10035 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10035 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10035 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10035 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10035 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10035 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10035 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10035 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10035 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10035 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10035 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10035 |            20 | t
 myschema2      | myseq1            |        10035 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10035 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20001 |            31 | t
 emaj_myschema2 | mytbl2_log_seq    |        20001 |            10 | t
 emaj_myschema2 | myTbl3_log_seq    |        20001 |            20 | t
 emaj_myschema2 | mytbl4_log_seq    |        20001 |            12 | t
 emaj_myschema2 | mytbl5_log_seq    |        20001 |            16 | t
 emaj_myschema2 | mytbl6_log_seq    |        20001 |            70 | t
 myschema2      | myseq1            |        20001 |          9999 | f
 myschema2      | myTbl3_col31_seq  |        20001 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20002 |            41 | t
 emaj_myschema2 | mytbl2_log_seq    |        20002 |            12 | t
 emaj_myschema2 | myTbl3_log_seq    |        20002 |            30 | t
 emaj_myschema2 | mytbl4_log_seq    |        20002 |            14 | t
 emaj_myschema2 | mytbl5_log_seq    |        20002 |            17 | t
 emaj_myschema2 | mytbl6_log_seq    |        20002 |            77 | t
 myschema2      | myseq1            |        20002 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        20002 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20201 |            51 | t
 emaj_myschema2 | mytbl2_log_seq    |        20201 |            14 | t
 emaj_myschema2 | myTbl3_log_seq    |        20201 |            40 | t
 emaj_myschema2 | mytbl4_log_seq    |        20201 |            16 | t
 emaj_myschema2 | mytbl5_log_seq    |        20201 |            18 | t
 emaj_myschema2 | mytbl6_log_seq    |        20201 |            82 | t
 myschema2      | myseq1            |        20201 |          9999 | f
 myschema2      | myTbl3_col31_seq  |        20201 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20202 |            61 | t
 emaj_myschema2 | mytbl2_log_seq    |        20202 |            16 | t
 emaj_myschema2 | myTbl3_log_seq    |        20202 |            50 | t
 emaj_myschema2 | mytbl4_log_seq    |        20202 |            18 | t
 emaj_myschema2 | mytbl5_log_seq    |        20202 |            19 | t
 emaj_myschema2 | mytbl6_log_seq    |        20202 |            89 | t
 myschema2      | myseq1            |        20202 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        20202 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20203 |            61 | t
 emaj_myschema2 | mytbl2_log_seq    |        20203 |            16 | t
 emaj_myschema2 | myTbl3_log_seq    |        20203 |            50 | t
 emaj_myschema2 | mytbl4_log_seq    |        20203 |            18 | t
 emaj_myschema2 | mytbl5_log_seq    |        20203 |            19 | t
 emaj_myschema2 | mytbl6_log_seq    |        20203 |            89 | t
 myschema2      | myseq1            |        20203 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        20203 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20204 |            81 | t
 emaj_myschema2 | mytbl2_log_seq    |        20204 |            20 | t
 emaj_myschema2 | myTbl3_log_seq    |        20204 |            70 | t
 emaj_myschema2 | mytbl4_log_seq    |        20204 |            22 | t
 emaj_myschema2 | mytbl5_log_seq    |        20204 |            21 | t
 emaj_myschema2 | mytbl6_log_seq    |        20204 |           101 | t
 myschema2      | myseq1            |        20204 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        20204 |            20 | t
 emaj_myschema2 | mytbl1_log_seq    |        20206 |            99 | t
 emaj_myschema2 | mytbl2_log_seq    |        20206 |            21 | t
 emaj_myschema2 | myTbl3_log_seq    |        20206 |            70 | t
 emaj_myschema2 | mytbl4_log_seq    |        20206 |            22 | t
 emaj_myschema2 | mytbl5_log_seq    |        20206 |            21 | t
 emaj_myschema2 | mytbl6_log_seq    |        20206 |           101 | t
 myschema2      | myseq1            |        20206 |          1004 | t
 myschema2      | myTbl3_col31_seq  |        20206 |            20 | t
(130 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13  
-------+------------+--------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   101 | KLM        | \x000c
   102 | KLM        | \x000c
   103 | KLM        | \x000c
   104 | KLM        | \x000c
   105 | KLM        | \x000c
   106 | KLM        | \x001c
   107 | KLM        | \x001c
   108 | KLM        | \x001c
   109 | KLM        | \x001c
   110 | KLM        | \x001c
(20 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 2010-01-01
     2 | DEF   | 
   100 | KLM   | 2012-12-31
(3 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl1_log order by col11, col12, emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl1_log" does not exist
LINE 1: ...t col11, col12, col13, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
select col21, col22, col23, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl2_log order by col21, emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl2_log" does not exist
LINE 1: ...t col21, col22, col23, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
select col31, col33, emaj_verb, emaj_tuple from "emajC"."myschema2_myTbl3_log" order by col31, emaj_gid, emaj_tuple desc;
ERROR:  relation "emajC.myschema2_myTbl3_log" does not exist
LINE 1: select col31, col33, emaj_verb, emaj_tuple from "emajC"."mys...
                                                        ^
select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl4_log order by col41, emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl4_log" does not exist
LINE 1: ..., col43, col44, col45, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
--
-----------------------------
-- Step 2 : for myGroup2, rollback to mark Multi-1 (set before dump/restore) 
-----------------------------
select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_rows from emaj.emaj_log_stat_group('myGroup2','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------
 myGroup2   | myschema2   | mytbl1     | Multi-1         |                |        84
 myGroup2   | myschema2   | mytbl2     | Multi-1         |                |        19
 myGroup2   | myschema2   | myTbl3     | Multi-1         |                |        60
 myGroup2   | myschema2   | mytbl4     | Multi-1         |                |        12
 myGroup2   | myschema2   | mytbl5     | Multi-1         |                |        14
 myGroup2   | myschema2   | mytbl6     | Multi-1         |                |        78
(6 rows)

select emaj.emaj_rollback_group('myGroup2','Multi-1');
 emaj_rollback_group 
---------------------
                   8
(1 row)

--
-----------------------------
-- Checking step 2
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |     mark_comment     | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+-----------------+------------------------+----------------------+---------------------------+------------------------------
 myGroup2   | M3                           |        10012 | t               | f                      | This mark is deleted |                         0 | 
 myGroup1   | M4                           |        10018 | t               | f                      |                      |                        10 | 
 myGroup1   | M5                           |        10019 | t               | f                      |                      |                         3 | 
 myGroup1   | Before logged rollback to M4 |        10025 | t               | f                      |                      |                        28 | 
 myGroup1   | STOP_%                       |        10027 | t               | f                      |                      |                         0 | 
 myGroup2   | STOP_%                       |        10027 | t               | f                      |                      |                         0 | 
 myGroup1   | Stop after rollback          |        10034 | t               | f                      |                      |                         0 | 
 myGroup2   | Stop after rollback          |        10034 | t               | f                      |                      |                         0 | 
 myGroup1   | Multi-1                      |        10035 | f               | f                      |                      |                         0 | 
 myGroup2   | Multi-1                      |        10035 | f               | f                      |                      |                           | 
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+-------------------+--------------+---------------+----------------
 emaj_myschema2 | mytbl1_log_seq    |        10012 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10012 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10012 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10012 |             4 | t
 emaj_myschema2 | mytbl5_log_seq    |        10012 |             4 | t
 emaj_myschema2 | mytbl6_log_seq    |        10012 |            14 | t
 myschema2      | myseq1            |        10012 |          1003 | t
 myschema2      | myTbl3_col31_seq  |        10012 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10018 |            30 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10018 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10018 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10018 |            10 | t
 emaj_myschema1 | mytbl4_log_seq    |        10018 |             8 | t
 myschema1      | mytbl2b_col20_seq |        10018 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10018 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10019 |            30 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10019 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10019 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10019 |            20 | t
 emaj_myschema1 | mytbl4_log_seq    |        10019 |             8 | t
 myschema1      | mytbl2b_col20_seq |        10019 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10019 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10025 |            32 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10025 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10025 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10025 |            20 | t
 emaj_myschema1 | mytbl4_log_seq    |        10025 |            12 | t
 myschema1      | mytbl2b_col20_seq |        10025 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10025 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10027 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10027 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10027 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10027 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10027 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10027 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10027 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10027 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10027 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10027 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10027 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10027 |            20 | t
 myschema2      | myseq1            |        10027 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10027 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10034 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10034 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10034 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10034 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10034 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10034 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10034 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10034 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10034 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10034 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10034 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10034 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10034 |            20 | t
 myschema2      | myseq1            |        10034 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10034 |            20 | t
 emaj_myschema1 | mytbl1_log_seq    |        10035 |            33 | t
 emaj_myschema1 | mytbl2b_log_seq   |        10035 |             3 | t
 emaj_myschema1 | mytbl2_log_seq    |        10035 |             3 | t
 emaj_myschema1 | myTbl3_log_seq    |        10035 |            45 | t
 emaj_myschema1 | mytbl4_log_seq    |        10035 |            14 | t
 emaj_myschema2 | mytbl1_log_seq    |        10035 |            15 | t
 emaj_myschema2 | mytbl2_log_seq    |        10035 |             2 | t
 emaj_myschema2 | myTbl3_log_seq    |        10035 |            10 | t
 emaj_myschema2 | mytbl4_log_seq    |        10035 |            10 | t
 emaj_myschema2 | mytbl5_log_seq    |        10035 |             7 | t
 emaj_myschema2 | mytbl6_log_seq    |        10035 |            23 | t
 myschema1      | mytbl2b_col20_seq |        10035 |             5 | t
 myschema1      | myTbl3_col31_seq  |        10035 |            20 | t
 myschema2      | myseq1            |        10035 |          1004 | f
 myschema2      | myTbl3_col31_seq  |        10035 |            20 | t
(74 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
      -8 |                    | 
      -7 |                    | 
      -6 |                    | 
      -5 |                    | 
      -4 |                    | 
      -3 |                    | 
      -2 |                    | 
      -1 |                    | 
       4 |                  0 | C
       5 |                  0 | C
       6 |                  0 | C
       8 |                  0 | C
       9 |                  0 | C
      10 |                  0 | C
      11 |                  0 | C
      12 |                  0 | D
      13 |                  0 | C
      15 |                  0 | A
      16 |                  0 | A
      17 |                  0 | A
      18 |                  0 | A
      19 |                  0 | A
      20 |                  0 | A
      21 |                  0 | D
      22 |                  0 | C
      23 |                  0 | A
      24 |                  0 | A
      25 |                  0 | A
      26 |                  0 | A
      27 |                  0 | A
      28 |                  0 | A
      29 |                  0 | D
      30 |                  0 | D
      31 |                  0 | C
      32 |                  0 | C
      33 |                  0 | M
      34 |                  0 | M
      36 |                  0 | D
      37 |                  0 | D
      38 |                  0 | D
      39 |                  0 | D
      40 |                  0 | D
      41 |                  0 | C
      42 |                  0 | M
      43 |                  0 | D
      44 |                  0 | C
      45 |                  0 | D
    1000 |                  0 | C
    1001 |                  0 | C
    1002 |                  0 | C
    1003 |                  0 | M
    1004 |                  0 | M
    1005 |                  0 | M
    1006 |                  0 | M
    1007 |                  0 | M
    1008 |                  0 | M
    1010 |                  0 | M
    1011 |                  0 | M
    1012 |                  2 | M
    1013 |                  2 | M
    1014 |                  2 | M
    1015 |                  2 | M
    1016 |                  2 | M
    1017 |                  2 | M
    1018 |                  2 | M
    1019 |                  2 | M
    1020 |                  2 | M
    1022 |                  2 | M
    1023 |                  2 | M
    1024 |                  2 | M
    1025 |                  2 | M
    1026 |                  2 | M
    1027 |                  2 | M
    1028 |                  2 | M
    2000 |              19999 | M
    2001 |              19999 | M
    2002 |              19999 | M
    2003 |              19999 | M
    2004 |              19999 | M
    2005 |              19999 | M
    2006 |              19999 | M
    2007 |              19999 | M
    2008 |              19999 | M
    2009 |              19999 | M
    2010 |              19999 | M
    2011 |              19999 | M
    2012 |              19999 | M
    2013 |              19999 | M
    2014 |              19999 | M
    2015 |              19999 | M
    2016 |              19999 | M
    2017 |              19999 | M
    2018 |              19999 | M
    2019 |              19999 | M
    2020 |              19999 | M
    3002 |              29999 | M
    3003 |              29999 | M
    3004 |              29999 | M
    3005 |              29999 | M
    3006 |              29999 | R
    3007 |              29999 | C
    3008 |              29999 | D
    3017 |              29999 | R
    3018 |              29999 | R
    3019 |              29999 | M
    3020 |              29999 | R
    3021 |              29999 | R
    3022 |              29999 | R
    3023 |              29999 | M
    3024 |              29999 | R
    3025 |              29999 | M
    3026 |              29999 | M
    3027 |              29999 | M
    3028 |              29999 | M
    3029 |              30026 | M
    3030 |              30038 | M
    3031 |              30038 | R
    3032 |              30038 | R
    3033 |              30038 | M
    3034 |              30038 | M
    3035 |              30057 | M
    3036 |              30068 | M
    3037 |              30068 | R
    3038 |              30079 | M
    3039 |              30079 | R
    3040 |              30093 | M
    3041 |              30093 | R
    3042 |              30093 | R
    3043 |              30093 | R
    3044 |              30093 | M
    3045 |              30093 | M
    3046 |              30096 | M
    3047 |              30099 | R
    3048 |              30102 | M
    3049 |              30102 | R
    3050 |              30102 | M
    3051 |              30102 | R
    3052 |              30102 | M
    3053 |              30102 | M
    3054 |              30117 | M
    3055 |              30119 | R
    3056 |              30134 | M
    3057 |              30136 | R
    3061 |              30137 | R
    5000 |              49999 | M
    5002 |              49999 | M
    5003 |              49999 | M
    5004 |              61599 | M
    5005 |              61599 | M
    5006 |              61709 | M
    5007 |              61709 | M
    5010 |              61720 | S
    5011 |              61720 | S
    5012 |              61720 | M
    6000 |              59999 | M
    6001 |              59999 | D
    6002 |              59999 | D
    6003 |              59999 | M
    6004 |              59999 | D
    6005 |              59999 | D
    6006 |              59999 | D
    6007 |              59999 | C
    6008 |              59999 | C
    6009 |              59999 | C
    6010 |              59999 | C
    6013 |              59999 | A
    6014 |              59999 | A
    6015 |              59999 | A
    6016 |              59999 | A
    6017 |              59999 | A
    6018 |              59999 | A
    6019 |              59999 | A
    6020 |              59999 | A
    6021 |              59999 | A
    6022 |              59999 | A
    6023 |              59999 | A
    6024 |              59999 | A
    6025 |              59999 | A
    6026 |              59999 | A
    6027 |              59999 | A
    6028 |              59999 | A
    6029 |              59999 | A
    6030 |              59999 | A
    6031 |              59999 | A
    6032 |              59999 | A
    6033 |              59999 | A
    6034 |              59999 | A
    6035 |              59999 | A
    6036 |              59999 | A
    6037 |              59999 | A
    6038 |              59999 | A
    6041 |              59999 | A
    6042 |              59999 | A
    6043 |              59999 | A
    6044 |              59999 | A
    6045 |              59999 | A
    6046 |              59999 | A
    6049 |              59999 | A
    6050 |              59999 | A
    6051 |              59999 | A
    6052 |              59999 | A
    6053 |              59999 | A
    6054 |              59999 | A
    6055 |              59999 | A
    6056 |              59999 | A
    6057 |              59999 | A
    6058 |              59999 | A
    6059 |              59999 | A
    6060 |              59999 | A
    6061 |              59999 | A
    6062 |              59999 | A
    6063 |              59999 | A
    6064 |              59999 | A
    6065 |              59999 | M
    6066 |              59999 | A
    6067 |              59999 | A
    6068 |              59999 | M
    6069 |              60001 | R
    6070 |              60001 | A
    6071 |              60001 | A
    6072 |              60001 | M
    6073 |              60001 | M
    6074 |              60001 | A
    6075 |              60001 | M
    6077 |              60001 | R
    6078 |              60001 | M
    6079 |              60001 | A
    6080 |              60001 | A
    6081 |              60001 | A
    6082 |              60001 | R
    6083 |              60001 | M
    6084 |              60001 | M
    6085 |              60001 | A
    6086 |              60001 | S
    6087 |              60001 | M
    6088 |              60001 | R
    6090 |              60001 | R
    6093 |              60001 | A
    6094 |              60001 | M
    6095 |              60001 | M
    6096 |              60001 | A
    6098 |              60003 | M
    6099 |              60004 | M
    6101 |              60004 | R
    6102 |              60008 | M
    6103 |              60011 | A
    6104 |              60011 | A
    6105 |              60012 | S
    6106 |              60012 | A
    6107 |              60012 | R
    6108 |              60013 | M
    6109 |              60014 | A
    6110 |              60014 | A
    6112 |              60014 | S
    6114 |              60015 | R
    6115 |              60016 | M
    6116 |              60016 | A
    6117 |              60016 | R
    6122 |              60016 | A
    6123 |              60016 | M
    6124 |              60016 | R
    6125 |              60016 | R
    6126 |              60016 | M
    6127 |              60016 | R
    6128 |              60016 | R
    6129 |              60016 | R
    6130 |              60016 | M
    6131 |              60016 | R
    6136 |              60016 | M
    6137 |              60019 | A
    6138 |              60019 | M
    6139 |              60021 | R
    6140 |              60025 | M
    6141 |              60025 | R
    6142 |              60025 | M
    6143 |              60025 | A
    6144 |              60025 | M
    6145 |              60026 | A
    6146 |              60026 | A
    6147 |              60026 | A
    6148 |              60026 | A
    6149 |              60027 | A
    6150 |              60027 | A
    6151 |              60027 | A
    6152 |              60027 | A
    6153 |              60027 | A
    6154 |              60027 | A
    6155 |              60027 | A
    6156 |              60027 | A
    6157 |              60027 | A
    6158 |              60027 | A
    6159 |              60027 | A
    6160 |              60027 | A
    6161 |              60027 | A
    6162 |              60027 | A
    6163 |              60027 | A
    6164 |              60027 | A
    6165 |              60027 | A
    6166 |              60027 | A
    6167 |              60027 | A
    6168 |              60027 | A
    6169 |              60027 | A
    6170 |              60027 | A
    6171 |              60027 | M
    6172 |              60027 | D
    6173 |              60027 | M
    6174 |              60027 | D
    6175 |              60027 | D
    6176 |              60027 | C
    6177 |              60027 | M
    6178 |              60027 | C
    6179 |              60027 | M
   10000 |              99999 | M
   10001 |              99999 | D
   10002 |              99999 | D
   10003 |              99999 | D
   10004 |              99999 | C
   10005 |              99999 | C
   10006 |              99999 | C
   10007 |              99999 | M
   10008 |              99999 | M
   10009 |             100028 | M
   10010 |             100039 | M
   10011 |             100080 | M
   10012 |             100088 | M
   10013 |             100088 | R
   10014 |             100094 | M
   10015 |             100094 | R
   10016 |             100100 | M
   10017 |             100100 | R
   10018 |             100114 | M
   10019 |             100124 | M
   10020 |             100124 | M
   10021 |             100124 | R
   10022 |             100130 | M
   10023 |             100130 | R
   10024 |             100133 | R
   10025 |             100136 | R
   10026 |             100159 | M
   10027 |             100164 | M
   10028 |             100164 | M
   10029 |             100164 | M
   10030 |             100164 | R
   10031 |             100164 | M
   10032 |             100164 | R
   10033 |             100164 | R
   10034 |             100164 | M
   10035 |             100164 | M
   10036 |             100164 | M
   10037 |             100164 | R
   10038 |             100164 | C
   10039 |             100164 | A
   10040 |             100164 | A
   10041 |             100164 | A
   10042 |             100164 | M
   10043 |             100164 | M
   10044 |             100164 | C
   10045 |             100164 | A
   10046 |             100164 | D
   10047 |             100164 | D
   10048 |             100164 | C
   10049 |             100164 | M
   10050 |             100216 | M
   10051 |             100216 | M
   10052 |             100219 | M
   10053 |             100219 | R
   10054 |             100219 | M
   10055 |             100219 | R
   10056 |             100239 | R
   10057 |             100269 | R
   10058 |             100269 | R
   10059 |             100269 | R
   10060 |             100354 | M
   10061 |             100354 | A
   10062 |             100354 | M
   10063 |             100358 | M
   10064 |             100360 | R
   10065 |             100360 | M
   10066 |             100360 | D
   10067 |             100360 | M
   10068 |             100360 | M
   10069 |             100377 | M
   10070 |             100379 | R
   10071 |             100393 | M
   10072 |             100395 | M
   10073 |             100407 | M
   10074 |             100407 | M
   10075 |             100407 | R
   10076 |             100418 | M
   10077 |             100418 | M
   10078 |             100435 | M
   10079 |             100437 | M
   10080 |             100439 | R
   10081 |             100441 | M
   10082 |             100441 | M
   10083 |             100453 | R
   10084 |             100478 | M
   10085 |             100478 | M
   10086 |             100494 | R
   10087 |             100500 | M
   10088 |             100500 | M
   10089 |             100502 | R
   10090 |             100503 | M
   10091 |             100503 | M
   10092 |             100520 | M
   10093 |             100522 | R
   10094 |             100536 | M
   10095 |             100536 | M
   10096 |             100538 | R
   10097 |             100553 | M
   10098 |             100553 | R
   10099 |             100553 | C
   10100 |             100553 | M
   10101 |             100553 | M
   10102 |             100553 | M
   10103 |             100553 | A
   10104 |             100553 | A
   10105 |             100553 | M
   10106 |             100553 | M
   10107 |             100553 | M
   10108 |             100553 | M
   10109 |             100553 | M
   10110 |             100553 | A
   10111 |             100553 | A
   10112 |             100553 | R
   10113 |             100553 | M
   10114 |             100553 | R
   10115 |             100553 | M
   10116 |             100553 | M
   10117 |             100553 | D
   10118 |             100553 | C
   10119 |             100553 | M
   10120 |             100563 | A
   10121 |             100563 | A
   10122 |             100563 | A
   10123 |             100563 | A
   10124 |             100563 | A
   10125 |             100563 | A
   10126 |             100563 | M
   10127 |             100563 | D
   10128 |             100563 | C
   10129 |             100563 | C
   10130 |             100563 | C
   10131 |             100563 | M
   10132 |             100563 | A
   10133 |             100563 | A
   10134 |             100563 | A
   10135 |             100563 | A
   10136 |             100563 | M
   10137 |             100563 | M
   10138 |             100574 | M
   10139 |             100587 | M
   10140 |             100591 | R
   10141 |             100591 | A
   10142 |             100591 | A
   10143 |             100591 | A
   10144 |             100591 | A
   10145 |             100591 | A
   10146 |             100591 | M
   10147 |             100596 | M
   10148 |             100600 | M
   10149 |             100604 | A
   10150 |             100604 | A
   10151 |             100604 | R
   10152 |             100608 | M
   10153 |             100608 | M
   10154 |             100614 | A
   10155 |             100614 | R
   10157 |             100614 | A
   10158 |             100614 | A
   10159 |             100614 | M
   10160 |             100614 | M
   10161 |             100614 | D
   10162 |             100614 | M
   10163 |             100614 | D
   10164 |             100614 | M
   10165 |             100614 | D
   20000 |             100693 | A
   20001 |             100693 | R
   20002 |             100756 | M
   20003 |             100756 | R
   20200 |             100823 | A
   20201 |             100823 | R
   20202 |             100886 | M
   20203 |             100886 | R
   20204 |             101010 | M
   20205 |             101010 | R
   20206 |             101029 | M
   20207 |             101029 | R
(489 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 2010-01-01
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl1_log" does not exist
LINE 1: ...t col11, col12, col13, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
select col21, col22, col23, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl2_log" does not exist
LINE 1: ...t col21, col22, col23, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
select col31, col33, emaj_verb, emaj_tuple from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emajC.myschema2_myTbl3_log" does not exist
LINE 1: select col31, col33, emaj_verb, emaj_tuple from "emajC"."mys...
                                                        ^
select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emaj.myschema2_mytbl4_log" does not exist
LINE 1: ..., col43, col44, col45, emaj_verb, emaj_tuple from emaj.mySch...
                                                             ^
--
-----------------------------
-- Step 3 : stop myGroup2
-----------------------------
select emaj.emaj_stop_group('myGroup2');
 emaj_stop_group 
-----------------
               8
(1 row)

--
-----------------------------
-- test end: check and reset history
-----------------------------
select count(*) from emaj.emaj_hist;
 count 
-------
   163
(1 row)

--select hist_id, hist_function, hist_event, hist_object, regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'), hist_user from 
--  (select * from emaj.emaj_hist order by hist_id) as t;
--
truncate emaj.emaj_hist;
TRUNCATE TABLE
alter sequence emaj.emaj_hist_hist_id_seq restart 30000;
ALTER SEQUENCE
