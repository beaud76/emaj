-- adm1.sql : complex scenarios executed by an emaj_adm role
--
SET datestyle TO ymd;
-- set sequence restart value
truncate emaj.emaj_hist;
alter sequence emaj.emaj_hist_hist_id_seq restart 10000;
alter sequence emaj.emaj_time_stamp_time_id_seq restart 10000;
alter sequence emaj.emaj_rlbk_rlbk_id_seq restart 10000;
alter sequence emaj.emaj_global_seq restart 100000;
-----------------------------
-- grant emaj_adm role 
-----------------------------
grant emaj_adm to emaj_regression_tests_adm_user;
--
set role emaj_regression_tests_adm_user;
-----------------------------
-- authorized table accesses
-----------------------------
select count(*) from emaj.emaj_param;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_visible_param;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_hist;
 count 
-------
     0
(1 row)

select count(*) from emaj.emaj_group;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_schema;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_relation;
 count 
-------
    15
(1 row)

select count(*) from emaj.emaj_rel_hist;
 count 
-------
   106
(1 row)

select count(*) from emaj.emaj_mark;
 count 
-------
     2
(1 row)

select count(*) from emaj.emaj_sequence;
 count 
-------
     2
(1 row)

select count(*) from emaj.emaj_table;
 count 
-------
     5
(1 row)

select count(*) from emaj.emaj_seq_hole;
 count 
-------
     0
(1 row)

select count(*) from emaj.emaj_rlbk;
 count 
-------
    37
(1 row)

select count(*) from emaj.emaj_rlbk_session;
 count 
-------
    37
(1 row)

select count(*) from emaj.emaj_rlbk_plan;
 count 
-------
   140
(1 row)

select count(*) from emaj.emaj_rlbk_stat;
 count 
-------
     7
(1 row)

select count(*) from emaj.emaj_ignored_app_trigger;
 count 
-------
     0
(1 row)

select count(*) from emaj_mySchema1.myTbl1_log;
 count 
-------
     0
(1 row)

-----------------------------
-- stop, reset and drop existing groups
-----------------------------
select emaj.emaj_stop_group('myGroup1','Simple stop mark');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_reset_group('myGroup1');
 emaj_reset_group 
------------------
                7
(1 row)

select emaj.emaj_drop_group('myGroup1');
 emaj_drop_group 
-----------------
               7
(1 row)

select emaj.emaj_force_drop_group('myGroup2');
 emaj_force_drop_group 
-----------------------
                     8
(1 row)

select emaj.emaj_force_stop_group('emptyGroup');
 emaj_force_stop_group 
-----------------------
                     0
(1 row)

select emaj.emaj_drop_group('emptyGroup');
 emaj_drop_group 
-----------------
               0
(1 row)

-- emaj tables
select * from emaj.emaj_group;
 group_name | group_is_rollbackable | group_creation_time_id | group_pg_version | group_last_alter_time_id | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_comment 
------------+-----------------------+------------------------+------------------+--------------------------+------------------+-------------------------+----------------+-------------------+---------------
(0 rows)

select sch_name from emaj.emaj_schema;
 sch_name 
----------
 emaj
(1 row)

select * from emaj.emaj_relation;
 rel_schema | rel_tblseq | rel_time_range | rel_group | rel_kind | rel_priority | rel_log_schema | rel_log_table | rel_log_dat_tsp | rel_log_index | rel_log_idx_tsp | rel_log_sequence | rel_log_function | rel_emaj_verb_attnum | rel_has_always_ident_col | rel_sql_rlbk_columns | rel_sql_rlbk_pk_columns | rel_sql_rlbk_pk_conditions | rel_sql_gen_ins_col | rel_sql_gen_ins_val | rel_sql_gen_upd_set | rel_sql_gen_pk_conditions | rel_log_seq_last_value 
------------+------------+----------------+-----------+----------+--------------+----------------+---------------+-----------------+---------------+-----------------+------------------+------------------+----------------------+--------------------------+----------------------+-------------------------+----------------------------+---------------------+---------------------+---------------------+---------------------------+------------------------
(0 rows)

select * from emaj.emaj_mark;
 mark_group | mark_name | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
(0 rows)

select * from emaj.emaj_sequence;
 sequ_schema | sequ_name | sequ_time_id | sequ_last_val | sequ_start_val | sequ_increment | sequ_max_val | sequ_min_val | sequ_cache_val | sequ_is_cycled | sequ_is_called 
-------------+-----------+--------------+---------------+----------------+----------------+--------------+--------------+----------------+----------------+----------------
(0 rows)

select * from emaj.emaj_table;
 tbl_schema | tbl_name | tbl_time_id | tbl_pages | tbl_tuples | tbl_log_seq_last_val 
------------+----------+-------------+-----------+------------+----------------------
(0 rows)

select * from emaj.emaj_seq_hole;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
(0 rows)

select count(*) from emaj.emaj_rlbk;
 count 
-------
    37
(1 row)

select count(*) from emaj.emaj_rlbk_session;
 count 
-------
    37
(1 row)

select count(*) from emaj.emaj_rlbk_plan;
 count 
-------
   140
(1 row)

select count(*) from emaj.emaj_rlbk_stat;
 count 
-------
     7
(1 row)

-----------------------------
-- cleanup application tables
-----------------------------
reset role;
truncate mySchema1.myTbl1, mySchema1.myTbl2, mySchema1."myTbl3", mySchema1.myTbl4, mySchema1.myTbl2b; 
truncate mySchema2.myTbl1, mySchema2.myTbl2, mySchema2."myTbl3", mySchema2.myTbl4, mySchema2.myTbl5, mySchema2.myTbl6, mySchema2.myTbl7, mySchema2.myTbl8;
insert into myschema2.myTbl7 select i from generate_series(0,100,1) i;
insert into myschema2.myTbl6 (col61) values (0);
insert into myschema2.myTbl8 (col81) values (0);
alter sequence mySchema2.mySeq1 restart 1000;
truncate mySchema4.myTblM, mySchema4.myTblC1, mySchema4.myTblC2;
truncate mySchema4.myTblP, mySchema4.myPartP1, mySchema4.myPartP2;
-- analyze to get some statistics
analyze;
set role emaj_regression_tests_adm_user;
-----------------------------
-- explicitely purge the histories
-----------------------------
select emaj.emaj_purge_histories('0 SECOND');
 emaj_purge_histories 
----------------------
 
(1 row)

select hist_function, hist_event, hist_wording
  from emaj.emaj_hist order by hist_id;
  hist_function  | hist_event |                                                        hist_wording                                                         
-----------------+------------+-----------------------------------------------------------------------------------------------------------------------------
 PURGE_HISTORIES | BEGIN      | Retention delay @ 0
 PURGE_HISTORIES |            | 20 emaj_hist rows deleted ; 121 relation history rows deleted ; 74 alter groups events deleted ; 37 rollback events deleted
 PURGE_HISTORIES | END        | 
(3 rows)

-----------------------------
-- recreate and start groups
-----------------------------
-- set the parameter to drop the emaj_user_port column and add an 'extra_col_appname' column
insert into emaj.emaj_param (param_key, param_value_text) values ('alter_log_table',
  'ADD COLUMN emaj_user_ip INET DEFAULT inet_client_addr(), ADD COLUMN extra_col_appname TEXT DEFAULT current_setting(''application_name'')');
select emaj.emaj_create_group('myGroup1');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_comment_group('myGroup1','This is group #1');
 emaj_comment_group 
--------------------
 
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl1','myGroup1','{"priority":20}'::jsonb);
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl1" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl2','myGroup1','{"log_data_tablespace":"tsplog1","log_index_tablespace":"tsplog1"}'::jsonb);
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2" does not exist, skipping
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers (mytbl2trg1, mytbl2trg2). They will be automatically disabled during E-Maj rollback operations, unless they have been recorded into the list of triggers that may be kept enabled, with the emaj_ignore_app_trigger() function.
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl2b','myGroup1','{"log_data_tablespace":"tsp log''2","log_index_tablespace":"tsp log''2"}'::jsonb);
NOTICE:  table "mytbl2b_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2b" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','myTbl3','myGroup1','{"priority":10,"log_data_tablespace":"tsplog1"}'::jsonb);
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.myTbl3" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl4','myGroup1','{"priority":20,"log_data_tablespace":"tsplog1","log_index_tablespace":"tsp log''2"}'::jsonb);
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl4" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_sequences('myschema1','.*',null,'myGroup1');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

select emaj.emaj_create_group('myGroup2');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_assign_tables('myschema2','.*','mytbl[7,8]','myGroup2');
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  table "mytbl5_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  table "mytbl6_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl6" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl6" does not exist, skipping
 emaj_assign_tables 
--------------------
                  6
(1 row)

select emaj.emaj_assign_sequences('myschema2','.*','myseq2','myGroup2');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

select emaj.emaj_create_group('emptyGroup');
 emaj_create_group 
-------------------
                 1
(1 row)

-- try to rename the last mark for a group that has no mark
select emaj.emaj_rename_mark_group('myGroup2','EMAJ_LAST_MARK','new_mark_name');
ERROR:  _check_mark_name: The group "myGroup2" has no mark.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,text) line 24 at RAISE
SQL statement "SELECT emaj._check_mark_name(v_groupNames := ARRAY[v_groupName], v_mark := v_mark, v_checkList := '')"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 14 at SQL statement
-- force a purge of the history, the alter and the rollback tables
INSERT INTO emaj.emaj_param (param_key, param_value_interval) VALUES ('history_retention','0.1 second'::interval);
select pg_sleep(0.2);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                7
(1 row)

delete from emaj.emaj_param where param_key = 'history_retention';
-- try to generate a sql script for 2 and 3 groups with a mix of groups with or without marks
select emaj.emaj_gen_sql_groups(array['myGroup1','myGroup2'],NULL,'EMAJ_LAST_MARK','/dev/null');
ERROR:  _check_marks_range: The group "myGroup2" has no mark.
CONTEXT:  PL/pgSQL function emaj._check_marks_range(text[],text,text) line 30 at RAISE
SQL statement "SELECT *                                                                           FROM emaj._check_marks_range(v_groupNames, v_firstMark, v_lastMark)"
PL/pgSQL function emaj._gen_sql_groups(text[],boolean,text,text,text,text[]) line 42 at SQL statement
PL/pgSQL function emaj.emaj_gen_sql_groups(text[],text,text,text,text[]) line 14 at RETURN
select emaj.emaj_gen_sql_groups(array['myGroup1','myGroup2','emptyGroup'],NULL,'EMAJ_LAST_MARK','/dev/null');
ERROR:  _check_marks_range: The groups "emptyGroup, myGroup2" have no mark.
CONTEXT:  PL/pgSQL function emaj._check_marks_range(text[],text,text) line 32 at RAISE
SQL statement "SELECT *                                                                           FROM emaj._check_marks_range(v_groupNames, v_firstMark, v_lastMark)"
PL/pgSQL function emaj._gen_sql_groups(text[],boolean,text,text,text,text[]) line 42 at SQL statement
PL/pgSQL function emaj.emaj_gen_sql_groups(text[],text,text,text,text[]) line 14 at RETURN
select emaj.emaj_start_group('myGroup2','M1');
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 emaj_start_group 
------------------
                8
(1 row)

-----------------------------
-- Step 1 : for myGroup1, update tables and set 2 marks
-----------------------------
--
set search_path=public,myschema1;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-12-31');
delete from myTbl1 where col11 > 10;
insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
select emaj.emaj_set_mark_group('myGroup1','M2');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
set search_path=public,myschema1;
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
insert into myTbl4 values (3,'FK...',1,10,'ABC');
-- the 2 next statements activate fkey on delete and on update clauses 
delete from myTbl1 where col11 = 10;
update myTbl1 set col12='DEF' where col11 <= 2;
--
select emaj.emaj_set_mark_group('myGroup1','M3');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','M3','Third mark set');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

-----------------------------
-- Checking step 1
-----------------------------
-- emaj tables
select group_name, group_is_rollbackable, group_creation_time_id,
       group_last_alter_time_id, group_is_logging, group_is_rlbk_protected, group_nb_table, group_nb_sequence, group_comment
  from emaj.emaj_group order by group_name;
 group_name | group_is_rollbackable | group_creation_time_id | group_last_alter_time_id | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence |  group_comment   
------------+-----------------------+------------------------+--------------------------+------------------+-------------------------+----------------+-------------------+------------------
 emptyGroup | t                     |                  10014 |                          | f                | f                       |              0 |                 0 | 
 myGroup1   | t                     |                  10004 |                    10010 | t                | f                       |              5 |                 2 | This is group #1
 myGroup2   | t                     |                  10011 |                    10013 | t                | f                       |              6 |                 2 | 
(3 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+-----------------+------------------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1   | M1             |        10015 | f               | f                      | f                      |                |                        29 | 
 myGroup2   | M1             |        10016 | f               | f                      | f                      |                |                         0 | 
 myGroup1   | M2             |        10017 | f               | f                      | f                      |                |                        11 | 
 myGroup1   | M3             |        10018 | f               | f                      | f                      | Third mark set |                           | 
(4 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema1   | myTbl3_col31_seq  |        10018 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10018 |             4 | t
(8 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_tuples, tbl_pages, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_tuples | tbl_pages | tbl_log_seq_last_val 
------------+----------+-------------+------------+-----------+----------------------
 myschema1  | myTbl3   |       10015 |          0 |         0 |                    0
 myschema1  | mytbl1   |       10015 |          0 |         0 |                    0
 myschema1  | mytbl2   |       10015 |          0 |         0 |                    0
 myschema1  | mytbl2b  |       10015 |          0 |         0 |                    0
 myschema1  | mytbl4   |       10015 |          0 |         0 |                    0
 myschema2  | myTbl3   |       10016 |          0 |         0 |                    0
 myschema2  | mytbl1   |       10016 |          0 |         0 |                    0
 myschema2  | mytbl2   |       10016 |          0 |         0 |                    0
 myschema2  | mytbl4   |       10016 |          0 |         0 |                    0
 myschema2  | mytbl5   |       10016 |          0 |         0 |                    0
 myschema2  | mytbl6   |       10016 |          1 |         1 |                    0
 myschema1  | myTbl3   |       10017 |          0 |         0 |                   10
 myschema1  | mytbl1   |       10017 |          0 |         0 |                   15
 myschema1  | mytbl2   |       10017 |          0 |         0 |                    2
 myschema1  | mytbl2b  |       10017 |          0 |         0 |                    2
 myschema1  | mytbl4   |       10017 |          0 |         0 |                    0
 myschema1  | myTbl3   |       10018 |          0 |         0 |                   10
 myschema1  | mytbl1   |       10018 |          0 |         0 |                   18
 myschema1  | mytbl2   |       10018 |          0 |         0 |                    2
 myschema1  | mytbl2b  |       10018 |          0 |         0 |                    2
 myschema1  | mytbl4   |       10018 |          0 |         0 |                    8
(21 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | DEF        | \x1c
     2 | DEF        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
(9 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
(2 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 | col22 | col23 
-------+-------+-------+-------
     3 |     1 |       | t
     4 |     2 |       | t
(2 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
     1 | FK... |     2 |       | 
     2 | FK... |     2 |       | 
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+------------+-------+-----------+------------+----------+-----------+--------------+-------------------
     1 | ABC        | \x0c  | INS       | NEW        |   100000 | postgres  |              | psql
     2 | ABC        | \x0c  | INS       | NEW        |   100001 | postgres  |              | psql
     3 | ABC        | \x0c  | INS       | NEW        |   100002 | postgres  |              | psql
     4 | ABC        | \x0c  | INS       | NEW        |   100003 | postgres  |              | psql
     5 | ABC        | \x0c  | INS       | NEW        |   100004 | postgres  |              | psql
     6 | ABC        | \x0c  | INS       | NEW        |   100005 | postgres  |              | psql
     7 | ABC        | \x0c  | INS       | NEW        |   100006 | postgres  |              | psql
     8 | ABC        | \x0c  | INS       | NEW        |   100007 | postgres  |              | psql
     9 | ABC        | \x0c  | INS       | NEW        |   100008 | postgres  |              | psql
    10 | ABC        | \x0c  | INS       | NEW        |   100009 | postgres  |              | psql
    11 | ABC        | \x0c  | INS       | NEW        |   100010 | postgres  |              | psql
     1 | ABC        | \x0c  | UPD       | OLD        |   100011 | postgres  |              | psql
     1 | ABC        | \x1c  | UPD       | NEW        |   100011 | postgres  |              | psql
     2 | ABC        | \x0c  | UPD       | OLD        |   100012 | postgres  |              | psql
     2 | ABC        | \x1c  | UPD       | NEW        |   100012 | postgres  |              | psql
     3 | ABC        | \x0c  | UPD       | OLD        |   100013 | postgres  |              | psql
     3 | ABC        | \x1c  | UPD       | NEW        |   100013 | postgres  |              | psql
    11 | ABC        | \x0c  | DEL       | OLD        |   100016 | postgres  |              | psql
    10 | ABC        | \x0c  | DEL       | OLD        |   100034 | postgres  |              | psql
     1 | ABC        | \x1c  | UPD       | OLD        |   100036 | postgres  |              | psql
     1 | DEF        | \x1c  | UPD       | NEW        |   100036 | postgres  |              | psql
     2 | ABC        | \x1c  | UPD       | OLD        |   100037 | postgres  |              | psql
     2 | DEF        | \x1c  | UPD       | NEW        |   100037 | postgres  |              | psql
(23 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+------------+-----------+------------+----------+-----------+--------------+-------------------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014 | postgres  |              | psql
     2 | DEF   |            | INS       | NEW        |   100017 | postgres  |              | psql
(2 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-------+-------+-----------+------------+----------+-----------+--------------+-------------------
     3 |     1 |       | t     | INS       | NEW        |   100015 | postgres  |              | psql
     4 |     2 |       | t     | INS       | NEW        |   100018 | postgres  |              | psql
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-----------+------------+----------+-----------+--------------+-------------------
    11 | 10.00 | INS       | NEW        |   100019 | postgres  |              | psql
    12 | 10.00 | INS       | NEW        |   100020 | postgres  |              | psql
    13 | 10.00 | INS       | NEW        |   100021 | postgres  |              | psql
    14 | 10.00 | INS       | NEW        |   100022 | postgres  |              | psql
    15 | 10.00 | INS       | NEW        |   100023 | postgres  |              | psql
    16 | 10.00 | INS       | NEW        |   100024 | postgres  |              | psql
    17 | 10.00 | INS       | NEW        |   100025 | postgres  |              | psql
    18 | 10.00 | INS       | NEW        |   100026 | postgres  |              | psql
    19 | 10.00 | INS       | NEW        |   100027 | postgres  |              | psql
    20 | 10.00 | INS       | NEW        |   100028 | postgres  |              | psql
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-------+-------+-------+-----------+------------+----------+-----------+--------------+-------------------
     1 | FK... |     1 |     1 | ABC   | INS       | NEW        |   100029 | postgres  |              | psql
     2 | FK... |     1 |     1 | ABC   | INS       | NEW        |   100030 | postgres  |              | psql
     1 | FK... |     1 |     1 | ABC   | UPD       | OLD        |   100031 | postgres  |              | psql
     1 | FK... |     2 |     1 | ABC   | UPD       | NEW        |   100031 | postgres  |              | psql
     2 | FK... |     1 |     1 | ABC   | UPD       | OLD        |   100032 | postgres  |              | psql
     2 | FK... |     2 |     1 | ABC   | UPD       | NEW        |   100032 | postgres  |              | psql
     3 | FK... |     1 |    10 | ABC   | INS       | NEW        |   100033 | postgres  |              | psql
     3 | FK... |     1 |    10 | ABC   | DEL       | OLD        |   100035 | postgres  |              | psql
     1 | FK... |     2 |     1 | ABC   | UPD       | OLD        |   100038 | postgres  |              | psql
     1 | FK... |     2 |       |       | UPD       | NEW        |   100038 | postgres  |              | psql
     2 | FK... |     2 |     1 | ABC   | UPD       | OLD        |   100039 | postgres  |              | psql
     2 | FK... |     2 |       |       | UPD       | NEW        |   100039 | postgres  |              | psql
(12 rows)

-----------------------------
-- Step 2 : for myGroup2, start, update tables and set 2 marks 
-----------------------------
set search_path=public,myschema2;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-01-01');
delete from myTbl1 where col11 > 10;
select nextval('myschema2.myseq1');
 nextval 
---------
    1000
(1 row)

insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
insert into myTbl5 values (1,'{"abc","def","ghi"}','{1,2,3}',NULL,'{}');
insert into myTbl5 values (2,array['abc','def','ghi'],array[3,4,5],array['2000/02/01'::date,'2000/02/28'::date],'{"id":1000, "c1":"abc"}');
update myTbl5 set col54 = '{"2010/11/28","2010/12/03"}', col55 = '{"id":1001, "c2":"def"}' where col54 is null;
insert into myTbl6 select i, point(i,1.3), '((0,0),(2,2))', circle(point(5,5),i),'((-2,-2),(3,0),(1,4))','10.20.30.40/27' from generate_series (1,8) as i;
update myTbl6 set col64 = '<(5,6),3.5>', col65 = null where col61 between 1 and 3;
--
select emaj.emaj_set_mark_group('myGroup2','M2');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

--
set search_path=public,myschema2;
select nextval('myschema2.myseq1');
 nextval 
---------
    1001
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1002
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1003
(1 row)

--
reset role;
alter sequence mySeq1 NO MAXVALUE NO CYCLE;
set role emaj_regression_tests_adm_user;
--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
delete from mytbl5 where 4 = any(col53);
delete from myTbl6 where col65 is null and col61 <> 0;
--
select emaj.emaj_set_mark_group('myGroup2','M3');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

-----------------------------
-- Checking step 2
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+-----------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1   | M1             |        10015 | f               | f                      |                |                        29 | 
 myGroup2   | M1             |        10016 | f               | f                      |                |                        41 | 
 myGroup1   | M2             |        10017 | f               | f                      |                |                        11 | 
 myGroup1   | M3             |        10018 | f               | f                      | Third mark set |                         0 | 
 myGroup2   | M2             |        10019 | f               | f                      |                |                         8 | 
 myGroup2   | M3             |        10020 | f               | f                      |                |                           | 
(6 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema1   | myTbl3_col31_seq  |        10018 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10018 |             4 | t
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
(12 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       10015 |                    0
 myschema1  | mytbl1   |       10015 |                    0
 myschema1  | mytbl2   |       10015 |                    0
 myschema1  | mytbl2b  |       10015 |                    0
 myschema1  | mytbl4   |       10015 |                    0
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema1  | myTbl3   |       10017 |                   10
 myschema1  | mytbl1   |       10017 |                   15
 myschema1  | mytbl2   |       10017 |                    2
 myschema1  | mytbl2b  |       10017 |                    2
 myschema1  | mytbl4   |       10017 |                    0
 myschema1  | myTbl3   |       10018 |                   10
 myschema1  | mytbl1   |       10018 |                   18
 myschema1  | mytbl2   |       10018 |                    2
 myschema1  | mytbl2b  |       10018 |                    2
 myschema1  | mytbl4   |       10018 |                    8
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
(33 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          
-------+---------------+---------+-------------------------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100040
     2 | ABC        | \x0c  | INS       | NEW        |   100041
     3 | ABC        | \x0c  | INS       | NEW        |   100042
     4 | ABC        | \x0c  | INS       | NEW        |   100043
     5 | ABC        | \x0c  | INS       | NEW        |   100044
     6 | ABC        | \x0c  | INS       | NEW        |   100045
     7 | ABC        | \x0c  | INS       | NEW        |   100046
     8 | ABC        | \x0c  | INS       | NEW        |   100047
     9 | ABC        | \x0c  | INS       | NEW        |   100048
    10 | ABC        | \x0c  | INS       | NEW        |   100049
    11 | ABC        | \x0c  | INS       | NEW        |   100050
     1 | ABC        | \x0c  | UPD       | OLD        |   100051
     1 | ABC        | \x1c  | UPD       | NEW        |   100051
     2 | ABC        | \x0c  | UPD       | OLD        |   100052
     2 | ABC        | \x1c  | UPD       | NEW        |   100052
     3 | ABC        | \x0c  | UPD       | OLD        |   100053
     3 | ABC        | \x1c  | UPD       | NEW        |   100053
    11 | ABC        | \x0c  | DEL       | OLD        |   100055
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100054
     2 | DEF   |            | INS       | NEW        |   100056
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100057
    12 | 10.00 | INS       | NEW        |   100058
    13 | 10.00 | INS       | NEW        |   100059
    14 | 10.00 | INS       | NEW        |   100060
    15 | 10.00 | INS       | NEW        |   100061
    16 | 10.00 | INS       | NEW        |   100062
    17 | 10.00 | INS       | NEW        |   100063
    18 | 10.00 | INS       | NEW        |   100064
    19 | 10.00 | INS       | NEW        |   100065
    20 | 10.00 | INS       | NEW        |   100066
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100082
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100083
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100083
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100084
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100084
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100068
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100069
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100069
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100085
(5 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100076
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100077
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100079
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100079
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100080
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100080
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100087
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100088
(17 rows)

-----------------------------
-- Step 3 : for myGroup2, double logged rollback
-----------------------------
reset role;
analyze mytbl4;
-- rollback with dblink_connect_u not granted
revoke execute on function dblink_connect_u(text,text) from emaj_adm;
set role emaj_regression_tests_adm_user;
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 sequences processed.
 Notice        | 3 / 6 tables effectively processed.
(2 rows)

select * from emaj.emaj_logged_rollback_group('myGroup2','M3',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 sequences processed.
 Notice        | 3 / 6 tables effectively processed.
(2 rows)

reset role;
grant execute on function dblink_connect_u(text,text) to emaj_adm;
set role emaj_regression_tests_adm_user;
-----------------------------
-- Checking step 3
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------------+--------------+-----------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1   | M1              |        10015 | f               | f                      |                |                        29 | 
 myGroup2   | M1              |        10016 | f               | f                      |                |                        41 | 
 myGroup1   | M2              |        10017 | f               | f                      |                |                        11 | 
 myGroup1   | M3              |        10018 | f               | f                      | Third mark set |                         0 | 
 myGroup2   | M2              |        10019 | f               | f                      |                |                         8 | 
 myGroup2   | M3              |        10020 | f               | f                      |                |                         0 | 
 myGroup2   | RLBK_M2_%_START |        10021 | f               | f                      |                |                         6 | 
 myGroup2   | RLBK_M2_%_DONE  |        10022 | f               | f                      |                |                         0 | M2
 myGroup2   | RLBK_M3_%_START |        10023 | f               | f                      |                |                         6 | 
 myGroup2   | RLBK_M3_%_DONE  |        10024 | f               | f                      |                |                           | M3
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema1   | myTbl3_col31_seq  |        10018 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10018 |             4 | t
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        10021 |            20 | t
 myschema2   | myseq1            |        10021 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        10022 |            20 | t
 myschema2   | myseq1            |        10022 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        10023 |            20 | t
 myschema2   | myseq1            |        10023 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        10024 |            20 | t
 myschema2   | myseq1            |        10024 |          1004 | f
(20 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       10015 |                    0
 myschema1  | mytbl1   |       10015 |                    0
 myschema1  | mytbl2   |       10015 |                    0
 myschema1  | mytbl2b  |       10015 |                    0
 myschema1  | mytbl4   |       10015 |                    0
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema1  | myTbl3   |       10017 |                   10
 myschema1  | mytbl1   |       10017 |                   15
 myschema1  | mytbl2   |       10017 |                    2
 myschema1  | mytbl2b  |       10017 |                    2
 myschema1  | mytbl4   |       10017 |                    0
 myschema1  | myTbl3   |       10018 |                   10
 myschema1  | mytbl1   |       10018 |                   18
 myschema1  | mytbl2   |       10018 |                    2
 myschema1  | mytbl2b  |       10018 |                    2
 myschema1  | mytbl4   |       10018 |                    8
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
 myschema2  | myTbl3   |       10021 |                   10
 myschema2  | mytbl1   |       10021 |                   15
 myschema2  | mytbl2   |       10021 |                    2
 myschema2  | mytbl4   |       10021 |                    4
 myschema2  | mytbl5   |       10021 |                    4
 myschema2  | mytbl6   |       10021 |                   14
 myschema2  | myTbl3   |       10022 |                   10
 myschema2  | mytbl1   |       10022 |                   15
 myschema2  | mytbl2   |       10022 |                    2
 myschema2  | mytbl4   |       10022 |                    6
 myschema2  | mytbl5   |       10022 |                    5
 myschema2  | mytbl6   |       10022 |                   17
 myschema2  | myTbl3   |       10023 |                   10
 myschema2  | mytbl1   |       10023 |                   15
 myschema2  | mytbl2   |       10023 |                    2
 myschema2  | mytbl4   |       10023 |                    6
 myschema2  | mytbl5   |       10023 |                    5
 myschema2  | mytbl6   |       10023 |                   17
 myschema2  | myTbl3   |       10024 |                   10
 myschema2  | mytbl1   |       10024 |                   15
 myschema2  | mytbl2   |       10024 |                    2
 myschema2  | mytbl4   |       10024 |                    8
 myschema2  | mytbl5   |       10024 |                    6
 myschema2  | mytbl6   |       10024 |                   20
(57 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          
-------+---------------+---------+-------------------------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100040
     2 | ABC        | \x0c  | INS       | NEW        |   100041
     3 | ABC        | \x0c  | INS       | NEW        |   100042
     4 | ABC        | \x0c  | INS       | NEW        |   100043
     5 | ABC        | \x0c  | INS       | NEW        |   100044
     6 | ABC        | \x0c  | INS       | NEW        |   100045
     7 | ABC        | \x0c  | INS       | NEW        |   100046
     8 | ABC        | \x0c  | INS       | NEW        |   100047
     9 | ABC        | \x0c  | INS       | NEW        |   100048
    10 | ABC        | \x0c  | INS       | NEW        |   100049
    11 | ABC        | \x0c  | INS       | NEW        |   100050
     1 | ABC        | \x0c  | UPD       | OLD        |   100051
     1 | ABC        | \x1c  | UPD       | NEW        |   100051
     2 | ABC        | \x0c  | UPD       | OLD        |   100052
     2 | ABC        | \x1c  | UPD       | NEW        |   100052
     3 | ABC        | \x0c  | UPD       | OLD        |   100053
     3 | ABC        | \x1c  | UPD       | NEW        |   100053
    11 | ABC        | \x0c  | DEL       | OLD        |   100055
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100054
     2 | DEF   |            | INS       | NEW        |   100056
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100057
    12 | 10.00 | INS       | NEW        |   100058
    13 | 10.00 | INS       | NEW        |   100059
    14 | 10.00 | INS       | NEW        |   100060
    15 | 10.00 | INS       | NEW        |   100061
    16 | 10.00 | INS       | NEW        |   100062
    17 | 10.00 | INS       | NEW        |   100063
    18 | 10.00 | INS       | NEW        |   100064
    19 | 10.00 | INS       | NEW        |   100065
    20 | 10.00 | INS       | NEW        |   100066
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100082
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100083
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100083
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100084
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100084
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        |   100089
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        |   100090
     1 | FK... |     2 |     1 | ABC        | INS       | NEW        |   100098
     2 | FK... |     2 |     1 | ABC        | INS       | NEW        |   100099
(10 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100068
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100069
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100069
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100085
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100094
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100100
(7 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100076
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100077
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100079
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100079
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100080
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100080
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100087
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100088
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100091
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100092
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100093
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100095
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100096
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100097
(23 rows)

-----------------------------
-- Step 4 : for myGroup1, rollback then update tables then set 3 marks
-----------------------------
select * from emaj.emaj_rollback_group('myGroup1','M2',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 / 5 tables effectively processed.
 Notice        | 2 sequences processed.
(2 rows)

--
set search_path=public,myschema1;
insert into myTbl1 select i, 'DEF', E'\\000'::bytea from generate_series (100,110) as i;
insert into myTbl2 values (3,'GHI','2010-01-02');
delete from myTbl1 where col11 = 1;
--
select emaj.emaj_set_mark_group('myGroup1','M4');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
update "myTbl3" set col33 = col33 / 2;
--
select emaj.emaj_set_mark_group('myGroup1','M5');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
update myTbl1 set col11 = 99 where col11 = 1;
--
select emaj.emaj_set_mark_group('myGroup1','M6');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

-----------------------------
-- Checking step 4
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | M1              |        10015 | f               | f                      |              |                        29 | 
 myGroup2   | M1              |        10016 | f               | f                      |              |                        41 | 
 myGroup1   | M2              |        10017 | f               | f                      |              |                        14 | 
 myGroup2   | M2              |        10019 | f               | f                      |              |                         8 | 
 myGroup2   | M3              |        10020 | f               | f                      |              |                         0 | 
 myGroup2   | RLBK_M2_%_START |        10021 | f               | f                      |              |                         6 | 
 myGroup2   | RLBK_M2_%_DONE  |        10022 | f               | f                      |              |                         0 | M2
 myGroup2   | RLBK_M3_%_START |        10023 | f               | f                      |              |                         6 | 
 myGroup2   | RLBK_M3_%_DONE  |        10024 | f               | f                      |              |                         0 | M3
 myGroup1   | M4              |        10026 | f               | f                      |              |                        10 | 
 myGroup1   | M5              |        10027 | f               | f                      |              |                         0 | 
 myGroup1   | M6              |        10028 | f               | f                      |              |                           | 
(12 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        10021 |            20 | t
 myschema2   | myseq1            |        10021 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        10022 |            20 | t
 myschema2   | myseq1            |        10022 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        10023 |            20 | t
 myschema2   | myseq1            |        10023 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        10024 |            20 | t
 myschema2   | myseq1            |        10024 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        10026 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10026 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10027 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10028 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10028 |             5 | t
(24 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       10015 |                    0
 myschema1  | mytbl1   |       10015 |                    0
 myschema1  | mytbl2   |       10015 |                    0
 myschema1  | mytbl2b  |       10015 |                    0
 myschema1  | mytbl4   |       10015 |                    0
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema1  | myTbl3   |       10017 |                   10
 myschema1  | mytbl1   |       10017 |                   15
 myschema1  | mytbl2   |       10017 |                    2
 myschema1  | mytbl2b  |       10017 |                    2
 myschema1  | mytbl4   |       10017 |                    0
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
 myschema2  | myTbl3   |       10021 |                   10
 myschema2  | mytbl1   |       10021 |                   15
 myschema2  | mytbl2   |       10021 |                    2
 myschema2  | mytbl4   |       10021 |                    4
 myschema2  | mytbl5   |       10021 |                    4
 myschema2  | mytbl6   |       10021 |                   14
 myschema2  | myTbl3   |       10022 |                   10
 myschema2  | mytbl1   |       10022 |                   15
 myschema2  | mytbl2   |       10022 |                    2
 myschema2  | mytbl4   |       10022 |                    6
 myschema2  | mytbl5   |       10022 |                    5
 myschema2  | mytbl6   |       10022 |                   17
 myschema2  | myTbl3   |       10023 |                   10
 myschema2  | mytbl1   |       10023 |                   15
 myschema2  | mytbl2   |       10023 |                    2
 myschema2  | mytbl4   |       10023 |                    6
 myschema2  | mytbl5   |       10023 |                    5
 myschema2  | mytbl6   |       10023 |                   17
 myschema2  | myTbl3   |       10024 |                   10
 myschema2  | mytbl1   |       10024 |                   15
 myschema2  | mytbl2   |       10024 |                    2
 myschema2  | mytbl4   |       10024 |                    8
 myschema2  | mytbl5   |       10024 |                    6
 myschema2  | mytbl6   |       10024 |                   20
 myschema1  | myTbl3   |       10026 |                   10
 myschema1  | mytbl1   |       10026 |                   30
 myschema1  | mytbl2   |       10026 |                    3
 myschema1  | mytbl2b  |       10026 |                    3
 myschema1  | mytbl4   |       10026 |                    8
 myschema1  | myTbl3   |       10027 |                   20
 myschema1  | mytbl1   |       10027 |                   30
 myschema1  | mytbl2   |       10027 |                    3
 myschema1  | mytbl2b  |       10027 |                    3
 myschema1  | mytbl4   |       10027 |                    8
 myschema1  | myTbl3   |       10028 |                   20
 myschema1  | mytbl1   |       10028 |                   30
 myschema1  | mytbl2   |       10028 |                    3
 myschema1  | mytbl2b  |       10028 |                    3
 myschema1  | mytbl4   |       10028 |                    8
(67 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 | col22 | col23 
-------+-------+-------+-------
     3 |     1 |       | t
     4 |     2 |       | t
     5 |     3 |       | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 |  5.00
    12 |  5.00
    13 |  5.00
    14 |  5.00
    15 |  5.00
    16 |  5.00
    17 |  5.00
    18 |  5.00
    19 |  5.00
    20 |  5.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100000
     2 | ABC        | \x0c  | INS       | NEW        |   100001
     3 | ABC        | \x0c  | INS       | NEW        |   100002
     4 | ABC        | \x0c  | INS       | NEW        |   100003
     5 | ABC        | \x0c  | INS       | NEW        |   100004
     6 | ABC        | \x0c  | INS       | NEW        |   100005
     7 | ABC        | \x0c  | INS       | NEW        |   100006
     8 | ABC        | \x0c  | INS       | NEW        |   100007
     9 | ABC        | \x0c  | INS       | NEW        |   100008
    10 | ABC        | \x0c  | INS       | NEW        |   100009
    11 | ABC        | \x0c  | INS       | NEW        |   100010
     1 | ABC        | \x0c  | UPD       | OLD        |   100011
     1 | ABC        | \x1c  | UPD       | NEW        |   100011
     2 | ABC        | \x0c  | UPD       | OLD        |   100012
     2 | ABC        | \x1c  | UPD       | NEW        |   100012
     3 | ABC        | \x0c  | UPD       | OLD        |   100013
     3 | ABC        | \x1c  | UPD       | NEW        |   100013
    11 | ABC        | \x0c  | DEL       | OLD        |   100016
   100 | DEF        | \x00  | INS       | NEW        |   100101
   101 | DEF        | \x00  | INS       | NEW        |   100102
   102 | DEF        | \x00  | INS       | NEW        |   100103
   103 | DEF        | \x00  | INS       | NEW        |   100104
   104 | DEF        | \x00  | INS       | NEW        |   100105
   105 | DEF        | \x00  | INS       | NEW        |   100106
   106 | DEF        | \x00  | INS       | NEW        |   100107
   107 | DEF        | \x00  | INS       | NEW        |   100108
   108 | DEF        | \x00  | INS       | NEW        |   100109
   109 | DEF        | \x00  | INS       | NEW        |   100110
   110 | DEF        | \x00  | INS       | NEW        |   100111
     1 | ABC        | \x1c  | DEL       | OLD        |   100114
(30 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014
     2 | DEF   |            | INS       | NEW        |   100017
     3 | GHI   | 01-02-2010 | INS       | NEW        |   100112
(3 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-----------+------------+----------
     3 |     1 |       | t     | INS       | NEW        |   100015
     4 |     2 |       | t     | INS       | NEW        |   100018
     5 |     3 |       | t     | INS       | NEW        |   100113
(3 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100019
    12 | 10.00 | INS       | NEW        |   100020
    13 | 10.00 | INS       | NEW        |   100021
    14 | 10.00 | INS       | NEW        |   100022
    15 | 10.00 | INS       | NEW        |   100023
    16 | 10.00 | INS       | NEW        |   100024
    17 | 10.00 | INS       | NEW        |   100025
    18 | 10.00 | INS       | NEW        |   100026
    19 | 10.00 | INS       | NEW        |   100027
    20 | 10.00 | INS       | NEW        |   100028
    11 | 10.00 | UPD       | OLD        |   100115
    11 |  5.00 | UPD       | NEW        |   100115
    12 | 10.00 | UPD       | OLD        |   100116
    12 |  5.00 | UPD       | NEW        |   100116
    13 | 10.00 | UPD       | OLD        |   100117
    13 |  5.00 | UPD       | NEW        |   100117
    14 | 10.00 | UPD       | OLD        |   100118
    14 |  5.00 | UPD       | NEW        |   100118
    15 | 10.00 | UPD       | OLD        |   100119
    15 |  5.00 | UPD       | NEW        |   100119
    16 | 10.00 | UPD       | OLD        |   100120
    16 |  5.00 | UPD       | NEW        |   100120
    17 | 10.00 | UPD       | OLD        |   100121
    17 |  5.00 | UPD       | NEW        |   100121
    18 | 10.00 | UPD       | OLD        |   100122
    18 |  5.00 | UPD       | NEW        |   100122
    19 | 10.00 | UPD       | OLD        |   100123
    19 |  5.00 | UPD       | NEW        |   100123
    20 | 10.00 | UPD       | OLD        |   100124
    20 |  5.00 | UPD       | NEW        |   100124
(30 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

-----------------------------
-- Step 5 : for myGroup2, logged rollback again then unlogged rollback 
-----------------------------
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 sequences processed.
 Notice        | 3 / 6 tables effectively processed.
(2 rows)

--
select * from emaj.emaj_rollback_group('myGroup2','M3',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 sequences processed.
 Notice        | 3 / 6 tables effectively processed.
(2 rows)

-----------------------------
-- Checking step 5
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | M1             |        10015 | f               | f                      |              |                        29 | 
 myGroup2   | M1             |        10016 | f               | f                      |              |                        41 | 
 myGroup1   | M2             |        10017 | f               | f                      |              |                        14 | 
 myGroup2   | M2             |        10019 | f               | f                      |              |                         8 | 
 myGroup2   | M3             |        10020 | f               | f                      |              |                           | 
 myGroup1   | M4             |        10026 | f               | f                      |              |                        10 | 
 myGroup1   | M5             |        10027 | f               | f                      |              |                         0 | 
 myGroup1   | M6             |        10028 | f               | f                      |              |                         0 | 
(8 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        10026 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10026 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10027 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10028 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10028 |             5 | t
(16 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       10015 |                    0
 myschema1  | mytbl1   |       10015 |                    0
 myschema1  | mytbl2   |       10015 |                    0
 myschema1  | mytbl2b  |       10015 |                    0
 myschema1  | mytbl4   |       10015 |                    0
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema1  | myTbl3   |       10017 |                   10
 myschema1  | mytbl1   |       10017 |                   15
 myschema1  | mytbl2   |       10017 |                    2
 myschema1  | mytbl2b  |       10017 |                    2
 myschema1  | mytbl4   |       10017 |                    0
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
 myschema1  | myTbl3   |       10026 |                   10
 myschema1  | mytbl1   |       10026 |                   30
 myschema1  | mytbl2   |       10026 |                    3
 myschema1  | mytbl2b  |       10026 |                    3
 myschema1  | mytbl4   |       10026 |                    8
 myschema1  | myTbl3   |       10027 |                   20
 myschema1  | mytbl1   |       10027 |                   30
 myschema1  | mytbl2   |       10027 |                    3
 myschema1  | mytbl2b  |       10027 |                    3
 myschema1  | mytbl4   |       10027 |                    8
 myschema1  | myTbl3   |       10028 |                   20
 myschema1  | mytbl1   |       10028 |                   30
 myschema1  | mytbl2   |       10028 |                    3
 myschema1  | mytbl2b  |       10028 |                    3
 myschema1  | mytbl4   |       10028 |                    8
(43 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10017 |            10025 |              3
 myschema1   | mytbl4     |              10017 |            10025 |              8
 myschema2   | mytbl4     |              10020 |            10031 |              6
 myschema2   | mytbl5     |              10020 |            10031 |              3
 myschema2   | mytbl6     |              10020 |            10031 |              9
(5 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          
-------+---------------+---------+-------------------------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100040
     2 | ABC        | \x0c  | INS       | NEW        |   100041
     3 | ABC        | \x0c  | INS       | NEW        |   100042
     4 | ABC        | \x0c  | INS       | NEW        |   100043
     5 | ABC        | \x0c  | INS       | NEW        |   100044
     6 | ABC        | \x0c  | INS       | NEW        |   100045
     7 | ABC        | \x0c  | INS       | NEW        |   100046
     8 | ABC        | \x0c  | INS       | NEW        |   100047
     9 | ABC        | \x0c  | INS       | NEW        |   100048
    10 | ABC        | \x0c  | INS       | NEW        |   100049
    11 | ABC        | \x0c  | INS       | NEW        |   100050
     1 | ABC        | \x0c  | UPD       | OLD        |   100051
     1 | ABC        | \x1c  | UPD       | NEW        |   100051
     2 | ABC        | \x0c  | UPD       | OLD        |   100052
     2 | ABC        | \x1c  | UPD       | NEW        |   100052
     3 | ABC        | \x0c  | UPD       | OLD        |   100053
     3 | ABC        | \x1c  | UPD       | NEW        |   100053
    11 | ABC        | \x0c  | DEL       | OLD        |   100055
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100054
     2 | DEF   |            | INS       | NEW        |   100056
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100057
    12 | 10.00 | INS       | NEW        |   100058
    13 | 10.00 | INS       | NEW        |   100059
    14 | 10.00 | INS       | NEW        |   100060
    15 | 10.00 | INS       | NEW        |   100061
    16 | 10.00 | INS       | NEW        |   100062
    17 | 10.00 | INS       | NEW        |   100063
    18 | 10.00 | INS       | NEW        |   100064
    19 | 10.00 | INS       | NEW        |   100065
    20 | 10.00 | INS       | NEW        |   100066
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100082
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100083
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100083
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100084
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100084
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100068
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100069
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100069
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100085
(5 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100076
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100077
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100079
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100079
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100080
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100080
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100087
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100088
(17 rows)

-----------------------------
-- Step 6 : for myGroup1, update tables, rollback, other updates, then logged rollback
-----------------------------
set search_path=public,myschema1;
--
insert into myTbl1 values (1, 'Step 6', E'\\000'::bytea);
insert into myTbl4 values (11,'FK...',1,1,'Step 6');
insert into myTbl4 values (12,'FK...',1,1,'Step 6');
--
select * from emaj.emaj_rollback_group('myGroup1','M5',false) order by 1,2;
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 2 / 5 tables effectively processed.
 Notice        | 2 sequences processed.
(2 rows)

--
insert into myTbl1 values (1, 'Step 6', E'\\001'::bytea);
insert into myTbl4 values (11,'',1,1,'Step 6');
insert into myTbl4 values (12,'',1,1,'Step 6');
--
-- for an equivalent of "select * from emaj.emaj_logged_rollback_group('myGroup1','M4',true);"
select * from emaj._rlbk_async(emaj._rlbk_init(array['myGroup1'], 'M4', true, 1, false, true), false);
 rlbk_severity |            rlbk_message             
---------------+-------------------------------------
 Notice        | 3 / 5 tables effectively processed.
 Notice        | 2 sequences processed.
(2 rows)

-- and check the rollback result
select rlbk_id, rlbk_groups, rlbk_mark, rlbk_mark_time_id, rlbk_time_id, rlbk_is_logged, rlbk_is_alter_group_allowed, 
       rlbk_nb_session, rlbk_nb_table, rlbk_nb_sequence, rlbk_eff_nb_table, rlbk_status, rlbk_begin_hist_id,
       rlbk_dblink_schema, rlbk_is_dblink_used, rlbk_messages
 from emaj.emaj_rlbk order by rlbk_id desc limit 1;
 rlbk_id | rlbk_groups | rlbk_mark | rlbk_mark_time_id | rlbk_time_id | rlbk_is_logged | rlbk_is_alter_group_allowed | rlbk_nb_session | rlbk_nb_table | rlbk_nb_sequence | rlbk_eff_nb_table | rlbk_status | rlbk_begin_hist_id | rlbk_dblink_schema | rlbk_is_dblink_used |                                  rlbk_messages                                   
---------+-------------+-----------+-------------------+--------------+----------------+-----------------------------+-----------------+---------------+------------------+-------------------+-------------+--------------------+--------------------+---------------------+----------------------------------------------------------------------------------
   10006 | {myGroup1}  | M4        |             10026 |        10033 | t              | t                           |               1 |             5 |                2 |                 3 | COMPLETED   |              10222 | public             | t                   | {"Notice: 3 / 5 tables effectively processed.","Notice: 2 sequences processed."}
(1 row)

-----------------------------
-- Checking step 6
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | M1              |        10015 | f               | f                      |              |                        29 | 
 myGroup2   | M1              |        10016 | f               | f                      |              |                        41 | 
 myGroup1   | M2              |        10017 | f               | f                      |              |                        14 | 
 myGroup2   | M2              |        10019 | f               | f                      |              |                         8 | 
 myGroup2   | M3              |        10020 | f               | f                      |              |                         0 | 
 myGroup1   | M4              |        10026 | f               | f                      |              |                        10 | 
 myGroup1   | M5              |        10027 | f               | f                      |              |                         3 | 
 myGroup1   | RLBK_M4_%_START |        10033 | f               | f                      |              |                        23 | 
 myGroup1   | RLBK_M4_%_DONE  |        10034 | f               | f                      |              |                           | M4
(9 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        10015 |            11 | f
 myschema1   | mytbl2b_col20_seq |        10015 |             3 | f
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        10017 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10017 |             4 | t
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        10026 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10026 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10027 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10033 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10033 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10034 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10034 |             5 | t
(18 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       10015 |                    0
 myschema1  | mytbl1   |       10015 |                    0
 myschema1  | mytbl2   |       10015 |                    0
 myschema1  | mytbl2b  |       10015 |                    0
 myschema1  | mytbl4   |       10015 |                    0
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema1  | myTbl3   |       10017 |                   10
 myschema1  | mytbl1   |       10017 |                   15
 myschema1  | mytbl2   |       10017 |                    2
 myschema1  | mytbl2b  |       10017 |                    2
 myschema1  | mytbl4   |       10017 |                    0
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
 myschema1  | myTbl3   |       10026 |                   10
 myschema1  | mytbl1   |       10026 |                   30
 myschema1  | mytbl2   |       10026 |                    3
 myschema1  | mytbl2b  |       10026 |                    3
 myschema1  | mytbl4   |       10026 |                    8
 myschema1  | myTbl3   |       10027 |                   20
 myschema1  | mytbl1   |       10027 |                   30
 myschema1  | mytbl2   |       10027 |                    3
 myschema1  | mytbl2b  |       10027 |                    3
 myschema1  | mytbl4   |       10027 |                    8
 myschema1  | myTbl3   |       10033 |                   20
 myschema1  | mytbl1   |       10033 |                   32
 myschema1  | mytbl2   |       10033 |                    3
 myschema1  | mytbl2b  |       10033 |                    3
 myschema1  | mytbl4   |       10033 |                   12
 myschema1  | myTbl3   |       10034 |                   40
 myschema1  | mytbl1   |       10034 |                   33
 myschema1  | mytbl2   |       10034 |                    3
 myschema1  | mytbl2b  |       10034 |                    3
 myschema1  | mytbl4   |       10034 |                   14
(48 rows)

-- check that mark_log_stat_before_next column is always equal to either NULL or the emaj_log_stat_rows() function's result
-- this should always return 0 row
select * from 
  (select mark_time_id, mark_group, mark_name, mark_log_rows_before_next - 
    (select sum(stat_rows) from emaj.emaj_log_stat_group(mark_group, mark_name, 
      (select mark_name from emaj.emaj_mark m2 where m2.mark_group = m1.mark_group and m2.mark_time_id > m1.mark_time_id order by mark_time_id limit 1))
    ) as checked_stat_rows from emaj.emaj_mark m1 where mark_log_rows_before_next is not null
  ) as t 
  where checked_stat_rows <> 0;  
 mark_time_id | mark_group | mark_name | checked_stat_rows 
--------------+------------+-----------+-------------------
(0 rows)

--
select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10017 |            10025 |              3
 myschema1   | mytbl1     |              10027 |            10032 |              1
 myschema1   | mytbl4     |              10017 |            10025 |              8
 myschema1   | mytbl4     |              10027 |            10032 |              2
 myschema2   | mytbl4     |              10020 |            10031 |              6
 myschema2   | mytbl5     |              10020 |            10031 |              3
 myschema2   | mytbl6     |              10020 |            10031 |              9
(7 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 | col22 | col23 
-------+-------+-------+-------
     3 |     1 |       | t
     4 |     2 |       | t
     5 |     3 |       | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100000
     2 | ABC        | \x0c  | INS       | NEW        |   100001
     3 | ABC        | \x0c  | INS       | NEW        |   100002
     4 | ABC        | \x0c  | INS       | NEW        |   100003
     5 | ABC        | \x0c  | INS       | NEW        |   100004
     6 | ABC        | \x0c  | INS       | NEW        |   100005
     7 | ABC        | \x0c  | INS       | NEW        |   100006
     8 | ABC        | \x0c  | INS       | NEW        |   100007
     9 | ABC        | \x0c  | INS       | NEW        |   100008
    10 | ABC        | \x0c  | INS       | NEW        |   100009
    11 | ABC        | \x0c  | INS       | NEW        |   100010
     1 | ABC        | \x0c  | UPD       | OLD        |   100011
     1 | ABC        | \x1c  | UPD       | NEW        |   100011
     2 | ABC        | \x0c  | UPD       | OLD        |   100012
     2 | ABC        | \x1c  | UPD       | NEW        |   100012
     3 | ABC        | \x0c  | UPD       | OLD        |   100013
     3 | ABC        | \x1c  | UPD       | NEW        |   100013
    11 | ABC        | \x0c  | DEL       | OLD        |   100016
   100 | DEF        | \x00  | INS       | NEW        |   100101
   101 | DEF        | \x00  | INS       | NEW        |   100102
   102 | DEF        | \x00  | INS       | NEW        |   100103
   103 | DEF        | \x00  | INS       | NEW        |   100104
   104 | DEF        | \x00  | INS       | NEW        |   100105
   105 | DEF        | \x00  | INS       | NEW        |   100106
   106 | DEF        | \x00  | INS       | NEW        |   100107
   107 | DEF        | \x00  | INS       | NEW        |   100108
   108 | DEF        | \x00  | INS       | NEW        |   100109
   109 | DEF        | \x00  | INS       | NEW        |   100110
   110 | DEF        | \x00  | INS       | NEW        |   100111
     1 | ABC        | \x1c  | DEL       | OLD        |   100114
     1 | Step 6     | \x01  | INS       | NEW        |   100134
     1 | Step 6     | \x01  | DEL       | OLD        |   100157
(32 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014
     2 | DEF   |            | INS       | NEW        |   100017
     3 | GHI   | 01-02-2010 | INS       | NEW        |   100112
(3 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-----------+------------+----------
     3 |     1 |       | t     | INS       | NEW        |   100015
     4 |     2 |       | t     | INS       | NEW        |   100018
     5 |     3 |       | t     | INS       | NEW        |   100113
(3 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100019
    12 | 10.00 | INS       | NEW        |   100020
    13 | 10.00 | INS       | NEW        |   100021
    14 | 10.00 | INS       | NEW        |   100022
    15 | 10.00 | INS       | NEW        |   100023
    16 | 10.00 | INS       | NEW        |   100024
    17 | 10.00 | INS       | NEW        |   100025
    18 | 10.00 | INS       | NEW        |   100026
    19 | 10.00 | INS       | NEW        |   100027
    20 | 10.00 | INS       | NEW        |   100028
    11 | 10.00 | UPD       | OLD        |   100115
    11 |  5.00 | UPD       | NEW        |   100115
    12 | 10.00 | UPD       | OLD        |   100116
    12 |  5.00 | UPD       | NEW        |   100116
    13 | 10.00 | UPD       | OLD        |   100117
    13 |  5.00 | UPD       | NEW        |   100117
    14 | 10.00 | UPD       | OLD        |   100118
    14 |  5.00 | UPD       | NEW        |   100118
    15 | 10.00 | UPD       | OLD        |   100119
    15 |  5.00 | UPD       | NEW        |   100119
    16 | 10.00 | UPD       | OLD        |   100120
    16 |  5.00 | UPD       | NEW        |   100120
    17 | 10.00 | UPD       | OLD        |   100121
    17 |  5.00 | UPD       | NEW        |   100121
    18 | 10.00 | UPD       | OLD        |   100122
    18 |  5.00 | UPD       | NEW        |   100122
    19 | 10.00 | UPD       | OLD        |   100123
    19 |  5.00 | UPD       | NEW        |   100123
    20 | 10.00 | UPD       | OLD        |   100124
    20 |  5.00 | UPD       | NEW        |   100124
    11 |  5.00 | DEL       | OLD        |   100137
    12 |  5.00 | DEL       | OLD        |   100138
    13 |  5.00 | DEL       | OLD        |   100139
    14 |  5.00 | DEL       | OLD        |   100140
    15 |  5.00 | DEL       | OLD        |   100141
    16 |  5.00 | DEL       | OLD        |   100142
    17 |  5.00 | DEL       | OLD        |   100143
    18 |  5.00 | DEL       | OLD        |   100144
    19 |  5.00 | DEL       | OLD        |   100145
    20 |  5.00 | DEL       | OLD        |   100146
    11 | 10.00 | INS       | NEW        |   100147
    12 | 10.00 | INS       | NEW        |   100148
    13 | 10.00 | INS       | NEW        |   100149
    14 | 10.00 | INS       | NEW        |   100150
    15 | 10.00 | INS       | NEW        |   100151
    16 | 10.00 | INS       | NEW        |   100152
    17 | 10.00 | INS       | NEW        |   100153
    18 | 10.00 | INS       | NEW        |   100154
    19 | 10.00 | INS       | NEW        |   100155
    20 | 10.00 | INS       | NEW        |   100156
(50 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45  | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+--------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6 | INS       | NEW        |   100135
    12 |       |     1 |     1 | Step 6 | INS       | NEW        |   100136
    11 |       |     1 |     1 | Step 6 | DEL       | OLD        |   100158
    12 |       |     1 |     1 | Step 6 | DEL       | OLD        |   100159
(4 rows)

-----------------------------
-- Step 7 : for myGroup1, update tables, rename a mark, then delete 2 marks then delete all before a mark 
-----------------------------
set search_path=public,myschema1;
--
delete from "myTbl3" where col31 = 14;
delete from "myTbl3" where col31 = 15;
delete from "myTbl3" where col31 = 16;
delete from "myTbl3" where col31 = 17;
delete from "myTbl3" where col31 = 18;
--
select emaj.emaj_rename_mark_group('myGroup1',mark_name,'Before logged rollback to M4') from emaj.emaj_mark where mark_name like 'RLBK_M4_%_START';
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- 
select emaj.emaj_delete_mark_group('myGroup1',mark_name) from emaj.emaj_mark where mark_name like 'RLBK_M4_%_DONE';
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select emaj.emaj_delete_mark_group('myGroup1','M1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

--
select emaj.emaj_delete_before_mark_group('myGroup1','M4');
 emaj_delete_before_mark_group 
-------------------------------
                             1
(1 row)

-----------------------------
-- Checking step 7
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
 myGroup2   | M1                           |        10016 | f               | f                      |              |                        41 | 
 myGroup2   | M2                           |        10019 | f               | f                      |              |                         8 | 
 myGroup2   | M3                           |        10020 | f               | f                      |              |                         0 | 
 myGroup1   | M4                           |        10026 | f               | f                      |              |                        10 | 
 myGroup1   | M5                           |        10027 | f               | f                      |              |                         3 | 
 myGroup1   | Before logged rollback to M4 |        10033 | f               | f                      |              |                           | 
(6 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 10000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   10000 |              99999 | M
   10001 |              99999 | D
   10002 |              99999 | D
   10003 |              99999 | D
   10004 |              99999 | C
   10005 |              99999 | A
   10006 |              99999 | A
   10007 |              99999 | A
   10008 |              99999 | A
   10009 |              99999 | A
   10010 |              99999 | A
   10011 |              99999 | C
   10012 |              99999 | A
   10013 |              99999 | A
   10014 |              99999 | C
   10015 |              99999 | M
   10016 |              99999 | M
   10017 |             100028 | M
   10018 |             100039 | M
   10019 |             100080 | M
   10020 |             100088 | M
   10021 |             100088 | R
   10022 |             100094 | M
   10023 |             100094 | R
   10024 |             100100 | M
   10025 |             100100 | R
   10026 |             100114 | M
   10027 |             100124 | M
   10028 |             100124 | M
   10029 |             100124 | R
   10030 |             100130 | M
   10031 |             100130 | R
   10032 |             100133 | R
   10033 |             100136 | R
   10034 |             100159 | M
(35 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema2   | myTbl3_col31_seq  |        10016 |            10 | t
 myschema2   | myseq1            |        10016 |          1000 | f
 myschema2   | myTbl3_col31_seq  |        10019 |            20 | t
 myschema2   | myseq1            |        10019 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        10020 |            20 | t
 myschema2   | myseq1            |        10020 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        10026 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10026 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10027 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10027 |             5 | t
 myschema1   | myTbl3_col31_seq  |        10033 |            20 | t
 myschema1   | mytbl2b_col20_seq |        10033 |             5 | t
(12 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema2  | myTbl3   |       10016 |                    0
 myschema2  | mytbl1   |       10016 |                    0
 myschema2  | mytbl2   |       10016 |                    0
 myschema2  | mytbl4   |       10016 |                    0
 myschema2  | mytbl5   |       10016 |                    0
 myschema2  | mytbl6   |       10016 |                    0
 myschema2  | myTbl3   |       10019 |                   10
 myschema2  | mytbl1   |       10019 |                   15
 myschema2  | mytbl2   |       10019 |                    2
 myschema2  | mytbl4   |       10019 |                    0
 myschema2  | mytbl5   |       10019 |                    3
 myschema2  | mytbl6   |       10019 |                   11
 myschema2  | myTbl3   |       10020 |                   10
 myschema2  | mytbl1   |       10020 |                   15
 myschema2  | mytbl2   |       10020 |                    2
 myschema2  | mytbl4   |       10020 |                    4
 myschema2  | mytbl5   |       10020 |                    4
 myschema2  | mytbl6   |       10020 |                   14
 myschema1  | myTbl3   |       10026 |                   10
 myschema1  | mytbl1   |       10026 |                   30
 myschema1  | mytbl2   |       10026 |                    3
 myschema1  | mytbl2b  |       10026 |                    3
 myschema1  | mytbl4   |       10026 |                    8
 myschema1  | myTbl3   |       10027 |                   20
 myschema1  | mytbl1   |       10027 |                   30
 myschema1  | mytbl2   |       10027 |                    3
 myschema1  | mytbl2b  |       10027 |                    3
 myschema1  | mytbl4   |       10027 |                    8
 myschema1  | myTbl3   |       10033 |                   20
 myschema1  | mytbl1   |       10033 |                   32
 myschema1  | mytbl2   |       10033 |                    3
 myschema1  | mytbl2b  |       10033 |                    3
 myschema1  | mytbl4   |       10033 |                   12
(33 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10027 |            10032 |              1
 myschema1   | mytbl4     |              10027 |            10032 |              2
 myschema2   | mytbl4     |              10020 |            10031 |              6
 myschema2   | mytbl5     |              10020 |            10031 |              3
 myschema2   | mytbl6     |              10020 |            10031 |              9
(5 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 | col22 | col23 
-------+-------+-------+-------
     3 |     1 |       | t
     4 |     2 |       | t
     5 |     3 |       | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    19 | 10.00
    20 | 10.00
(5 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | Step 6     | \x01  | INS       | NEW        |   100134
     1 | Step 6     | \x01  | DEL       | OLD        |   100157
(2 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | UPD       | OLD        |   100115
    11 |  5.00 | UPD       | NEW        |   100115
    12 | 10.00 | UPD       | OLD        |   100116
    12 |  5.00 | UPD       | NEW        |   100116
    13 | 10.00 | UPD       | OLD        |   100117
    13 |  5.00 | UPD       | NEW        |   100117
    14 | 10.00 | UPD       | OLD        |   100118
    14 |  5.00 | UPD       | NEW        |   100118
    15 | 10.00 | UPD       | OLD        |   100119
    15 |  5.00 | UPD       | NEW        |   100119
    16 | 10.00 | UPD       | OLD        |   100120
    16 |  5.00 | UPD       | NEW        |   100120
    17 | 10.00 | UPD       | OLD        |   100121
    17 |  5.00 | UPD       | NEW        |   100121
    18 | 10.00 | UPD       | OLD        |   100122
    18 |  5.00 | UPD       | NEW        |   100122
    19 | 10.00 | UPD       | OLD        |   100123
    19 |  5.00 | UPD       | NEW        |   100123
    20 | 10.00 | UPD       | OLD        |   100124
    20 |  5.00 | UPD       | NEW        |   100124
    11 |  5.00 | DEL       | OLD        |   100137
    12 |  5.00 | DEL       | OLD        |   100138
    13 |  5.00 | DEL       | OLD        |   100139
    14 |  5.00 | DEL       | OLD        |   100140
    15 |  5.00 | DEL       | OLD        |   100141
    16 |  5.00 | DEL       | OLD        |   100142
    17 |  5.00 | DEL       | OLD        |   100143
    18 |  5.00 | DEL       | OLD        |   100144
    19 |  5.00 | DEL       | OLD        |   100145
    20 |  5.00 | DEL       | OLD        |   100146
    11 | 10.00 | INS       | NEW        |   100147
    12 | 10.00 | INS       | NEW        |   100148
    13 | 10.00 | INS       | NEW        |   100149
    14 | 10.00 | INS       | NEW        |   100150
    15 | 10.00 | INS       | NEW        |   100151
    16 | 10.00 | INS       | NEW        |   100152
    17 | 10.00 | INS       | NEW        |   100153
    18 | 10.00 | INS       | NEW        |   100154
    19 | 10.00 | INS       | NEW        |   100155
    20 | 10.00 | INS       | NEW        |   100156
    14 | 10.00 | DEL       | OLD        |   100160
    15 | 10.00 | DEL       | OLD        |   100161
    16 | 10.00 | DEL       | OLD        |   100162
    17 | 10.00 | DEL       | OLD        |   100163
    18 | 10.00 | DEL       | OLD        |   100164
(45 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45  | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+--------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6 | INS       | NEW        |   100135
    12 |       |     1 |     1 | Step 6 | INS       | NEW        |   100136
    11 |       |     1 |     1 | Step 6 | DEL       | OLD        |   100158
    12 |       |     1 |     1 | Step 6 | DEL       | OLD        |   100159
(4 rows)

--
--		grp1									grp2
--1	M1 up M2 up M3 
--2											M1 up M2 up M3
--3											LR-M2 (->M2%S+M2%E) LR-M3 (->M3%S+M3%E)
--4	R-M2 up M4 up M5 up M6
--5											LR-M2 (->M2%S+M2%E) R-M3
--6	up R-M5 up LR-M4(->M4S+M4E)
--7	up M7 REN-M4S DEL-M4E DEL-M1 DELBEF-M4
--
-----------------------------
-- check grants on other functions to emaj_adm role
-----------------------------
select * from emaj.emaj_verify_all();
                                                                                      emaj_verify_all                                                                                       
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Warning: In the group "myGroup2", the foreign key "mytbl6_col61_fkey" on the table "myschema2"."mytbl6" references the table "myschema2"."mytbl7" that does not belong to any group.
 Warning: In the group "myGroup2", the table "myschema2"."mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" of the table "myschema2"."mytbl8" that does not belong to any group.
 No error detected
(3 rows)

select emaj.emaj_create_group('');
ERROR:  emaj_create_group: The group name can't be NULL or empty.
CONTEXT:  PL/pgSQL function emaj.emaj_create_group(text,boolean) line 14 at RAISE
select emaj.emaj_drop_group('dummyGroup');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := ARRAY[v_groupName], v_mayBeNull := FALSE, v_lockGroups := TRUE, v_checkList := 'IDLE')"
PL/pgSQL function emaj.emaj_drop_group(text) line 12 at PERFORM
select emaj.emaj_force_drop_group('dummyGroup');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := ARRAY[v_groupName], v_mayBeNull := FALSE, v_lockGroups := TRUE, v_checkList := '')"
PL/pgSQL function emaj.emaj_force_drop_group(text) line 17 at PERFORM
select emaj.emaj_get_previous_mark_group('dummyGroup', '2010-01-01');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := ARRAY[v_groupName], v_mayBeNull := FALSE, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 9 at PERFORM
select emaj.emaj_get_previous_mark_group('dummyGroup', 'EMAJ_LAST_MARK');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := ARRAY[v_groupName], v_mayBeNull := FALSE, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 9 at PERFORM
select * from emaj.emaj_log_stat_group('dummyGroup', 'dummyMark', NULL); 
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._log_stat_groups(text[],boolean,text,text) line 24 at SQL statement
PL/pgSQL function emaj.emaj_log_stat_group(text,text,text) line 7 at RETURN QUERY
select * from emaj.emaj_log_stat_groups(array['dummyGroup'], 'dummyMark', NULL); 
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._log_stat_groups(text[],boolean,text,text) line 24 at SQL statement
PL/pgSQL function emaj.emaj_log_stat_groups(text[],text,text) line 7 at RETURN QUERY
select * from emaj.emaj_detailed_log_stat_group('dummyGroup', 'dummyMark', NULL);
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._detailed_log_stat_groups(text[],boolean,text,text) line 32 at PERFORM
PL/pgSQL function emaj.emaj_detailed_log_stat_group(text,text,text) line 8 at RETURN QUERY
select * from emaj.emaj_detailed_log_stat_groups(array['dummyGroup'],NULL,NULL);
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._detailed_log_stat_groups(text[],boolean,text,text) line 32 at PERFORM
PL/pgSQL function emaj.emaj_detailed_log_stat_groups(text[],text,text) line 8 at RETURN QUERY
select emaj.emaj_estimate_rollback_group('dummyGroup', 'dummyMark', TRUE);
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._estimate_rollback_groups(text[],boolean,text,boolean) line 17 at SQL statement
PL/pgSQL function emaj.emaj_estimate_rollback_group(text,text,boolean) line 7 at RETURN
select emaj.emaj_estimate_rollback_groups(array['dummyGroup'], 'dummyMark', FALSE);
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,text) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(v_groupNames := v_groupNames, v_mayBeNull := v_multiGroup, v_lockGroups := FALSE, v_checkList := '')"
PL/pgSQL function emaj._estimate_rollback_groups(text[],boolean,text,boolean) line 17 at SQL statement
PL/pgSQL function emaj.emaj_estimate_rollback_groups(text[],text,boolean) line 7 at RETURN
select * from emaj.emaj_rollback_activity();
 rlbk_id | rlbk_groups | rlbk_mark | rlbk_mark_datetime | rlbk_is_logged | rlbk_is_alter_group_allowed | rlbk_nb_session | rlbk_nb_table | rlbk_nb_sequence | rlbk_eff_nb_table | rlbk_status | rlbk_start_datetime | rlbk_elapse | rlbk_remaining | rlbk_completion_pct 
---------+-------------+-----------+--------------------+----------------+-----------------------------+-----------------+---------------+------------------+-------------------+-------------+---------------------+-------------+----------------+---------------------
(0 rows)

select substr(pg_size_pretty(pg_database_size(current_database())),1,0);
 substr 
--------
 
(1 row)

